<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VocabMaster ‚Äî —É—á–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</title>
    <meta name="theme-color" content="#6C63FF" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="VocabMaster" />
    <link rel="manifest" id="pwa-manifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
      :root {
        --primary: #6c63ff;
        --primary-light: #8b84ff;
        --primary-dark: #5548e0;
        --bg: #f0f2ff;
        --card: #ffffff;
        --text: #2d2b55;
        --muted: #8884aa;
        --border: #e0deff;
        --success: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --radius: 16px;
        --shadow: 0 4px 20px rgba(108, 99, 255, 0.1);
        --shadow-hover: 0 8px 30px rgba(108, 99, 255, 0.18);
      }
      body.dark {
        --primary: #7c73ff;
        --primary-light: #9a94ff;
        --bg: #13121f;
        --card: #1e1c30;
        --text: #e8e6ff;
        --muted: #7a78a0;
        --border: #2e2c48;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.5);
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Nunito', sans-serif;
        background: var(--bg);
        color: var(--text);
        transition:
          background 0.3s,
          color 0.3s;
        min-height: 100vh;
      }

      header {
        background: var(--card);
        box-shadow: var(--shadow);
        padding: 0 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
        height: 64px;
      }
      .logo {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--primary);
        letter-spacing: -0.5px;
      }
      .logo span {
        color: var(--text);
      }
      nav {
        display: flex;
        gap: 4px;
      }
      .nav-btn {
        background: none;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--muted);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .nav-btn:hover {
        background: var(--bg);
        color: var(--text);
      }
      .nav-btn.active {
        background: var(--primary);
        color: #fff;
      }
      .nav-btn .badge {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 1px 7px;
        font-size: 0.75rem;
      }
      .nav-btn:not(.active) .badge {
        background: var(--border);
        color: var(--text);
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .dark-btn {
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 50%;
        width: 38px;
        height: 38px;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .dark-btn:hover {
        border-color: var(--primary);
        transform: scale(1.1);
      }

      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem;
      }
      .tab-pane {
        display: none;
        animation: fadeUp 0.3s ease;
      }
      .tab-pane.active {
        display: block;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 0.55rem 1.1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.9rem;
        font-weight: 700;
        transition: all 0.18s;
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.07);
      }
      .btn:active {
        transform: scale(0.97);
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-secondary {
        background: var(--border);
        color: var(--text);
      }
      .btn-success {
        background: var(--success);
        color: #fff;
      }
      .btn-danger {
        background: var(--danger);
        color: #fff;
      }
      .btn-warning {
        background: var(--warning);
        color: #fff;
      }
      .btn-audio {
        background: var(--bg);
        border: 2px solid var(--border);
        color: var(--primary);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
      }
      .btn-audio:hover {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
        transform: scale(1.1);
      }
      .btn-audio.speaking {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
        animation: pulse-ring 0.6s ease infinite;
      }
      @keyframes pulse-ring {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(108, 99, 255, 0);
        }
      }
      .btn-lg {
        padding: 0.8rem 1.8rem;
        font-size: 1rem;
        border-radius: 12px;
      }
      .btn-sm {
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
        border-radius: 8px;
      }

      .form-group {
        margin-bottom: 1.2rem;
      }
      .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.4rem;
        font-size: 0.9rem;
        color: var(--muted);
      }
      input[type='text'],
      textarea,
      select {
        width: 100%;
        padding: 0.7rem 1rem;
        border: 2px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
        color: var(--text);
        font-family: inherit;
        font-size: 1rem;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
        outline: none;
      }
      input[type='text']:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.12);
      }
      textarea {
        resize: vertical;
        min-height: 110px;
      }
      .section-title {
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 1.5rem;
      }
      .section-subtitle {
        font-size: 0.95rem;
        color: var(--muted);
        margin-top: 0.3rem;
        font-weight: 600;
      }

      /* WORDS */
      .words-toolbar {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .words-toolbar input {
        flex: 1;
        min-width: 200px;
      }
      .filter-pills {
        display: flex;
        gap: 0.4rem;
      }
      .pill {
        padding: 0.4rem 0.9rem;
        border: 2px solid var(--border);
        background: var(--card);
        border-radius: 20px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--muted);
        transition: all 0.18s;
      }
      .pill:hover,
      .pill.active {
        border-color: var(--primary);
        background: var(--primary);
        color: #fff;
      }
      .words-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.2rem;
      }
      .word-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.25rem;
        box-shadow: var(--shadow);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        border: 2px solid transparent;
      }
      .word-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
        border-color: var(--border);
      }
      .word-card.editing {
        border-color: var(--primary);
      }
      .wc-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.2rem;
      }
      .wc-english {
        font-size: 1.3rem;
        font-weight: 800;
      }
      .wc-russian {
        font-size: 1.05rem;
        color: var(--muted);
        font-weight: 600;
        margin-bottom: 0.4rem;
      }
      .wc-example {
        font-size: 0.82rem;
        color: var(--muted);
        font-style: italic;
        margin-bottom: 0.75rem;
      }
      .wc-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.4rem;
      }
      .wc-streak {
        display: flex;
        gap: 4px;
      }
      .dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--border);
        transition: background 0.3s;
      }
      .dot.on {
        background: var(--primary);
      }
      .wc-badges {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .badge-learned {
        background: #d1fae5;
        color: #065f46;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
      }
      body.dark .badge-learned {
        background: #064e3b;
        color: #6ee7b7;
      }
      .badge-tag {
        background: var(--border);
        color: var(--text);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
      }
      .wc-actions {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.75rem;
      }
      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--muted);
      }
      .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }
      .empty-state h3 {
        font-size: 1.3rem;
        margin-bottom: 0.5rem;
        color: var(--text);
      }

      /* ADD */
      .add-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }
      @media (max-width: 700px) {
        .add-layout {
          grid-template-columns: 1fr;
        }
      }
      .add-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.75rem;
        box-shadow: var(--shadow);
      }
      .add-card h3 {
        font-size: 1.1rem;
        font-weight: 800;
        margin-bottom: 1.2rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .drop-zone {
        border: 3px dashed var(--border);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--muted);
      }
      .drop-zone:hover,
      .drop-zone.over {
        border-color: var(--primary);
        background: rgba(108, 99, 255, 0.05);
        color: var(--primary);
      }
      .drop-zone .dz-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }
      .drop-zone p {
        font-size: 0.9rem;
        font-weight: 600;
      }
      .preview-wrap {
        margin-top: 1rem;
        overflow-x: auto;
      }
      .preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      .preview-table th,
      .preview-table td {
        padding: 0.4rem 0.6rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      .preview-table th {
        font-weight: 700;
        color: var(--muted);
      }
      .preview-table input[type='checkbox'] {
        accent-color: var(--primary);
        width: 15px;
        height: 15px;
      }

      /* PRACTICE */
      .practice-wrap {
        max-width: 560px;
        margin: 0 auto;
      }
      .setup-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow);
      }
      .setup-card h2 {
        font-size: 1.3rem;
        font-weight: 800;
        margin-bottom: 1.5rem;
      }
      .setup-row {
        margin-bottom: 1.4rem;
      }
      .setup-row > label {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--muted);
        display: block;
        margin-bottom: 0.5rem;
      }
      .chip-group {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .chip {
        padding: 0.4rem 0.9rem;
        border: 2px solid var(--border);
        background: var(--card);
        border-radius: 20px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text);
        transition: all 0.18s;
      }
      .chip:hover,
      .chip.on {
        border-color: var(--primary);
        background: var(--primary);
        color: #fff;
      }
      .check-row {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-bottom: 0.4rem;
        font-weight: 600;
        cursor: pointer;
      }
      .check-row input {
        accent-color: var(--primary);
        width: 17px;
        height: 17px;
        cursor: pointer;
      }

      /* EXERCISE */
      .ex-wrap {
        background: var(--card);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow);
      }
      .ex-progress {
        margin-bottom: 1.5rem;
      }
      .ex-progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--muted);
        margin-bottom: 0.4rem;
      }
      .prog-bar {
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
      }
      .prog-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        border-radius: 4px;
        transition: width 0.4s ease;
      }

      /* FLASHCARD */
      .flashcard-scene {
        perspective: 1000px;
        margin: 1rem 0;
        cursor: pointer;
      }
      .flashcard-inner {
        position: relative;
        width: 100%;
        height: 220px;
        transform-style: preserve-3d;
        transition: transform 0.55s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .flashcard-inner.flipped {
        transform: rotateY(180deg);
      }
      .card-face {
        position: absolute;
        inset: 0;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
      }
      .card-face.back {
        transform: rotateY(180deg);
      }
      .card-word {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--text);
      }
      .card-hint {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 0.5rem;
        font-weight: 600;
      }
      .card-trans {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--primary);
      }
      .card-ex {
        font-size: 0.85rem;
        color: var(--muted);
        font-style: italic;
        margin-top: 0.6rem;
        text-align: center;
      }

      /* AUDIO WAVE ANIMATION */
      .audio-wave {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        height: 16px;
      }
      .audio-wave span {
        display: block;
        width: 3px;
        background: currentColor;
        border-radius: 2px;
        animation: wave 0.8s ease-in-out infinite;
      }
      .audio-wave span:nth-child(1) {
        animation-delay: 0s;
        height: 6px;
      }
      .audio-wave span:nth-child(2) {
        animation-delay: 0.1s;
        height: 12px;
      }
      .audio-wave span:nth-child(3) {
        animation-delay: 0.2s;
        height: 8px;
      }
      .audio-wave span:nth-child(4) {
        animation-delay: 0.3s;
        height: 14px;
      }
      .audio-wave span:nth-child(5) {
        animation-delay: 0.4s;
        height: 6px;
      }
      @keyframes wave {
        0%,
        100% {
          transform: scaleY(1);
        }
        50% {
          transform: scaleY(1.8);
        }
      }

      /* DICTATION MODE */
      .dictation-card {
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 14px;
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
      }
      .dictation-big {
        font-size: 4rem;
        margin-bottom: 0.5rem;
      }
      .dictation-hint {
        color: var(--muted);
        font-size: 0.9rem;
        font-weight: 600;
      }
      .dictation-reveal {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--primary);
        margin-top: 1rem;
        display: none;
      }

      /* MULTIPLE CHOICE */
      .mc-question {
        font-size: 1.5rem;
        font-weight: 800;
        text-align: center;
        margin: 1rem 0 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
      }
      .mc-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }
      .mc-btn {
        padding: 1rem;
        border: 2px solid var(--border);
        background: var(--card);
        border-radius: 12px;
        cursor: pointer;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 700;
        color: var(--text);
        transition: all 0.18s;
        text-align: center;
      }
      .mc-btn:hover:not(:disabled) {
        border-color: var(--primary);
        background: rgba(108, 99, 255, 0.08);
      }
      .mc-btn.correct {
        background: var(--success);
        border-color: var(--success);
        color: #fff;
      }
      .mc-btn.wrong {
        background: var(--danger);
        border-color: var(--danger);
        color: #fff;
      }

      /* TYPE ANSWER */
      .ta-word {
        font-size: 2rem;
        font-weight: 800;
        text-align: center;
        margin: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
      }
      .ta-row {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
      }
      .ta-row input {
        flex: 1;
      }
      .ta-feedback {
        text-align: center;
        margin-top: 0.75rem;
        font-size: 1rem;
        font-weight: 700;
        min-height: 1.5rem;
      }
      .ta-feedback.ok {
        color: var(--success);
      }
      .ta-feedback.err {
        color: var(--danger);
      }
      .ex-btns {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      /* RESULTS */
      .results-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 2.5rem;
        box-shadow: var(--shadow);
        text-align: center;
      }
      .results-score {
        font-size: 4rem;
        font-weight: 800;
        color: var(--primary);
        line-height: 1;
      }
      .results-label {
        font-size: 1rem;
        color: var(--muted);
        font-weight: 600;
        margin-bottom: 1.5rem;
      }
      .breakdown {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        text-align: left;
        margin: 1.5rem 0;
      }
      .breakdown-col h4 {
        font-size: 0.9rem;
        font-weight: 800;
        margin-bottom: 0.6rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .breakdown-list {
        list-style: none;
      }
      .breakdown-list li {
        padding: 0.3rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
        font-weight: 600;
      }

      /* STATS */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.2rem;
        margin-bottom: 2rem;
      }
      .stat-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        text-align: center;
      }
      .stat-num {
        font-size: 2.4rem;
        font-weight: 800;
        color: var(--primary);
        line-height: 1;
      }
      .stat-lbl {
        font-size: 0.85rem;
        color: var(--muted);
        font-weight: 700;
        margin-top: 0.3rem;
      }
      .stat-prog {
        margin-top: 0.8rem;
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
      }
      .stat-prog-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        border-radius: 4px;
        transition: width 0.6s ease;
      }
      .sparkline-wrap {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
      }
      .sparkline-wrap h3 {
        font-size: 1rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      .spark-svg {
        width: 100%;
        height: 80px;
      }
      .spark-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
        font-weight: 600;
        margin-top: 0.3rem;
      }
      .word-lists {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
      @media (max-width: 600px) {
        .word-lists {
          grid-template-columns: 1fr;
        }
      }
      .word-list-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
      }
      .word-list-card h3 {
        font-size: 1rem;
        font-weight: 800;
        margin-bottom: 0.75rem;
      }
      .wlist {
        list-style: none;
      }
      .wlist li {
        display: flex;
        justify-content: space-between;
        padding: 0.4rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
        font-weight: 600;
        align-items: center;
        gap: 0.5rem;
      }
      .wlist li .cnt {
        color: var(--muted);
        font-size: 0.8rem;
      }

      /* SPEECH SETTINGS */
      .speech-settings {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
      }
      .speech-settings h3 {
        font-size: 1rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      .speech-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .speech-row label {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--muted);
        min-width: 80px;
      }
      .speech-row select,
      .speech-row input[type='range'] {
        flex: 1;
        min-width: 120px;
      }
      .voice-test {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      /* TOAST */
      #toast-box {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        pointer-events: none;
      }
      .toast {
        background: var(--card);
        border-radius: 10px;
        padding: 0.7rem 1.2rem;
        box-shadow: var(--shadow-hover);
        font-weight: 700;
        font-size: 0.9rem;
        border-left: 4px solid var(--success);
        pointer-events: none;
        animation: toastIn 0.3s ease;
        max-width: 280px;
      }
      .toast.danger {
        border-left-color: var(--danger);
      }
      .toast.warning {
        border-left-color: var(--warning);
      }
      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* MODAL */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-backdrop.open {
        display: flex;
      }
      .modal-box {
        background: var(--card);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 420px;
        width: 90%;
        box-shadow: var(--shadow-hover);
      }
      .modal-box h3 {
        font-size: 1.2rem;
        font-weight: 800;
        margin-bottom: 0.75rem;
      }
      .modal-box p {
        color: var(--muted);
        font-weight: 600;
        margin-bottom: 1.5rem;
      }
      .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      /* CONFETTI */
      .confetti-piece {
        position: fixed;
        pointer-events: none;
        z-index: 9998;
        animation: cFall linear forwards;
      }
      @keyframes cFall {
        to {
          transform: translateY(110vh) rotate(720deg);
          opacity: 0;
        }
      }

      /* NO SPEECH BANNER */
      .no-speech {
        background: #fef3c7;
        color: #92400e;
        border-radius: 10px;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        font-weight: 700;
        margin-bottom: 1rem;
        display: none;
      }
      body.dark .no-speech {
        background: #451a03;
        color: #fcd34d;
      }

      @media (max-width: 768px) {
        header {
          padding: 0 1rem;
          height: auto;
          flex-wrap: wrap;
          padding: 0.75rem 1rem;
          gap: 0.5rem;
        }
        nav {
          gap: 2px;
        }
        .nav-btn {
          padding: 0.4rem 0.6rem;
          font-size: 0.8rem;
        }
        main {
          padding: 1rem;
        }
        .mc-grid {
          grid-template-columns: 1fr;
        }
        .breakdown {
          grid-template-columns: 1fr;
        }
        .add-layout {
          grid-template-columns: 1fr;
        }
      }

      /* === SRS === */
      .due-now {
        background: #fee2e2;
        color: #991b1b;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.78rem;
        font-weight: 700;
      }
      .due-soon {
        background: #fef3c7;
        color: #92400e;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.78rem;
        font-weight: 700;
      }
      .due-later {
        color: var(--muted);
        font-size: 0.78rem;
        font-weight: 600;
      }
      .srs-meta {
        font-size: 0.72rem;
        color: var(--muted);
        margin-top: 4px;
      }
      .due-pill {
        background: var(--danger);
        color: white;
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 0.72rem;
        font-weight: 700;
        margin-left: 4px;
      }
      .stat-card.srs-hl {
        border: 2px solid var(--primary);
      }
      body.dark .due-now {
        background: #450a0a;
        color: #fca5a5;
      }
      body.dark .due-soon {
        background: #451a03;
        color: #fcd34d;
      }

      /* === XP + BADGES === */
      .xp-bar-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--primary);
      }
      .xp-bar-bg {
        flex: 1;
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
        min-width: 80px;
      }
      .xp-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), #a78bfa);
        border-radius: 4px;
        transition: width 0.5s ease;
      }
      .xp-level-lbl {
        font-size: 0.75rem;
        white-space: nowrap;
      }

      .badges-section {
        margin-top: 1.5rem;
      }
      .badges-section h3 {
        font-size: 1rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      .badges-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 0.75rem;
      }
      .badge-card {
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem 0.7rem;
        text-align: center;
        transition: all 0.3s;
      }
      .badge-card.unlocked {
        border-color: var(--primary);
        background: linear-gradient(
          135deg,
          rgba(108, 99, 255, 0.1),
          rgba(108, 99, 255, 0.02)
        );
        box-shadow: 0 2px 12px rgba(108, 99, 255, 0.2);
      }
      .badge-card.locked {
        opacity: 0.4;
        filter: grayscale(1);
      }
      .badge-icon {
        font-size: 2rem;
        margin-bottom: 0.3rem;
      }
      .badge-name {
        font-size: 0.78rem;
        font-weight: 800;
        margin-bottom: 0.15rem;
      }
      .badge-desc {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .xp-toast {
        position: fixed;
        right: 1rem;
        bottom: 4.5rem;
        background: var(--primary);
        color: #fff;
        padding: 0.5rem 1.1rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.85rem;
        animation:
          xpPop 0.5s ease,
          xpFade 2.5s ease forwards;
        z-index: 9999;
        pointer-events: none;
      }
      @keyframes xpPop {
        0% {
          transform: scale(0.5) translateY(20px);
          opacity: 0;
        }
        60% {
          transform: scale(1.15) translateY(-5px);
        }
        100% {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }
      @keyframes xpFade {
        0% {
          opacity: 1;
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateY(-20px);
        }
      }

      .level-up-banner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: linear-gradient(135deg, var(--primary), #a78bfa);
        color: #fff;
        border-radius: 20px;
        padding: 1.5rem 2.5rem;
        text-align: center;
        z-index: 10000;
        font-size: 1.2rem;
        font-weight: 800;
        box-shadow: 0 8px 32px rgba(108, 99, 255, 0.5);
        animation: lvlUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }
      @keyframes lvlUp {
        to {
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .xp-stats-row {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.2rem;
      }
      .xp-big {
        font-size: 2rem;
        font-weight: 900;
        color: var(--primary);
        line-height: 1.1;
      }
      .xp-sub {
        font-size: 0.82rem;
        color: var(--muted);
        margin-top: 0.1rem;
      }

      /* === IMPORT/EXPORT === */
      .io-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      .io-modal-overlay.open {
        display: flex;
      }
      .io-modal {
        background: var(--card);
        border-radius: var(--radius);
        padding: 1.5rem;
        width: min(420px, 90vw);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      }
      .io-modal h3 {
        font-size: 1.1rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      .io-btn-group {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        margin-bottom: 1rem;
      }
      .io-btn {
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: var(--card);
        color: var(--text);
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        text-align: left;
        transition: all 0.2s;
      }
      .io-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .io-btn .io-btn-sub {
        font-size: 0.75rem;
        font-weight: 400;
        color: var(--muted);
        display: block;
        margin-top: 0.15rem;
      }
      .io-close {
        width: 100%;
        padding: 0.6rem;
        border: none;
        background: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .io-close:hover {
        color: var(--text);
      }
      .io-drop-zone {
        border: 2px dashed var(--border);
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        color: var(--muted);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.75rem;
      }
      .io-drop-zone:hover,
      .io-drop-zone.drag-over {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(108, 99, 255, 0.05);
      }

      /* SORT */
      .sort-select {
        padding: 0.4rem 0.8rem;
        border: 2px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 20px;
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 700;
        cursor: pointer;
        transition: border-color 0.18s;
        outline: none;
      }
      .sort-select:hover,
      .sort-select:focus {
        border-color: var(--primary);
      }

      /* WORD ADD ANIMATION */
      @keyframes cardPop {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.5);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 8px rgba(108, 99, 255, 0.15);
        }
        100% {
          transform: scale(1);
          box-shadow: var(--shadow);
          opacity: 1;
        }
      }
      .word-card--new {
        animation: cardPop 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        border-color: var(--primary) !important;
      }

      /* UNDO TOAST */
      .toast-undo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        justify-content: space-between;
        pointer-events: all;
      }
      .toast-undo-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1.5px solid rgba(255, 255, 255, 0.4);
        color: #fff;
        border-radius: 8px;
        padding: 0.25rem 0.65rem;
        font-family: inherit;
        font-size: 0.8rem;
        font-weight: 800;
        cursor: pointer;
        transition: background 0.15s;
        white-space: nowrap;
      }
      .toast-undo-btn:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      /* HOTKEYS */
      .hotkeys-hint {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 0.6rem;
      }
      .hk {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.72rem;
        color: var(--muted);
      }
      .hk kbd {
        background: var(--card);
        border: 1.5px solid var(--border);
        border-radius: 5px;
        padding: 0.1rem 0.4rem;
        font-family: inherit;
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--text);
      }

      /* DUE BADGE */
      .nav-due-badge {
        display: inline-block;
        background: var(--danger);
        color: #fff;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 800;
        padding: 0.05rem 0.38rem;
        margin-left: 0.3rem;
        min-width: 1.2em;
        text-align: center;
        vertical-align: middle;
        animation: pulseBadge 1.8s infinite;
      }
      @keyframes pulseBadge {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.65;
        }
      }

      /* WORD OF THE DAY */
      .wotd-card {
        background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
        color: #fff;
        border-radius: var(--radius);
        padding: 1.2rem 1.5rem;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        box-shadow: 0 4px 18px rgba(108, 99, 255, 0.35);
      }
      .wotd-label {
        font-size: 0.7rem;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.8;
        margin-bottom: 0.25rem;
      }
      .wotd-en {
        font-size: 1.6rem;
        font-weight: 900;
      }
      .wotd-ru {
        font-size: 0.95rem;
        opacity: 0.85;
        margin-top: 0.2rem;
      }
      .wotd-ex {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.3rem;
        font-style: italic;
      }
      .wotd-audio {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #fff;
        border-radius: 50%;
        width: 2.4rem;
        height: 2.4rem;
        font-size: 1.1rem;
        cursor: pointer;
        flex-shrink: 0;
        transition: background 0.15s;
      }
      .wotd-audio:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      /* TAG FILTER */
      .tag-filter-btn {
        cursor: pointer;
        transition:
          opacity 0.15s,
          transform 0.1s;
      }
      .tag-filter-btn:hover {
        opacity: 0.7;
        transform: scale(1.08);
      }
      .tag-filter-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: var(--primary);
        color: #fff;
        border-radius: 16px;
        padding: 0.25rem 0.8rem;
        font-size: 0.78rem;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: 0.75rem;
      }
      .tag-filter-indicator:hover {
        opacity: 0.85;
      }

      /* MATCH MADNESS */
      .match-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
        margin-top: 0.5rem;
      }
      .match-btn {
        padding: 0.75rem 0.6rem;
        border: 2.5px solid var(--border);
        background: var(--card);
        color: var(--text);
        border-radius: 12px;
        font-family: inherit;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.15s;
        text-align: center;
        min-height: 3.2rem;
        line-height: 1.2;
      }
      .match-btn:hover:not(:disabled) {
        border-color: var(--primary);
        background: rgba(108, 99, 255, 0.07);
      }
      .match-btn.selected {
        border-color: var(--primary);
        background: rgba(108, 99, 255, 0.15);
        color: var(--primary);
        transform: scale(1.03);
      }
      .match-btn.correct {
        border-color: var(--success);
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        pointer-events: none;
      }
      .match-btn.wrong {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.12);
        animation: shake 0.3s ease;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .match-btn:disabled {
        opacity: 0.35;
        cursor: default;
      }
      .match-progress {
        text-align: center;
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 0.5rem;
      }
      .match-timer {
        font-size: 1.5rem;
        font-weight: 900;
        text-align: center;
        color: var(--primary);
        margin-bottom: 0.25rem;
      }

      .ex-exit-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--muted);
        font-size: 0.85rem;
        font-weight: 700;
        cursor: pointer;
        padding: 0.3rem 0.7rem;
        border-radius: 8px;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }
      .ex-exit-btn:hover {
        background: var(--danger);
        color: #fff;
      }
      .ex-wrap {
        position: relative;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">Vocab<span>Master</span></div>
      <nav>
        <button class="nav-btn active" data-tab="words">
          üìö –°–ª–æ–≤–∞ <span class="badge" id="words-count">0</span>
        </button>
        <button class="nav-btn" data-tab="add">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="nav-btn" data-tab="practice">
          üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞<span
            class="nav-due-badge"
            id="due-badge"
            style="display: none"
            >0</span
          >
        </button>
        <button class="nav-btn" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </nav>
      <div class="xp-bar-wrap">
        <span class="xp-level-lbl" id="xp-level-lbl">‚ö° –£—Ä. 1</span>
        <div class="xp-bar-bg">
          <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%"></div>
        </div>
        <span
          style="font-size: 0.7rem; color: var(--muted); white-space: nowrap"
          id="xp-num"
          >0/100</span
        >
      </div>
      <div class="header-right">
        <button class="btn btn-secondary btn-sm" id="export-btn">
          ‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç
        </button>
        <button class="btn btn-primary btn-sm" id="import-btn">
          ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç
        </button>
        <button class="btn btn-secondary btn-sm" id="auth-btn">–í–æ–π—Ç–∏</button>
        <button class="dark-btn" id="dark-toggle">üåô</button>
      </div>
    </header>

    <main>
      <!-- TAB: WORDS -->
      <div class="tab-pane active" id="tab-words">
        <div class="section-title">
          –ú–æ–∏ —Å–ª–æ–≤–∞ <span class="section-subtitle" id="words-subtitle"></span>
        </div>
        <div class="no-speech" id="no-speech-banner">
          ‚ö†Ô∏è –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Chrome.
        </div>
        <div id="wotd-wrap"></div>
        <div class="words-toolbar">
          <input
            type="text"
            id="search-input"
            placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞–º, —Ç–µ–≥–∞–º..."
          />
          <div class="filter-pills">
            <button class="pill active" data-filter="all">–í—Å–µ</button>
            <button class="pill" data-filter="learning">–£—á—É</button>
            <button class="pill" data-filter="learned">–ó–Ω–∞—é ‚úÖ</button>
          </div>
          <select id="sort-select" class="sort-select" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
            <option value="date-desc">üïê –ù–æ–≤—ã–µ</option>
            <option value="date-asc">üïê –°—Ç–∞—Ä—ã–µ</option>
            <option value="alpha-asc">üî§ A ‚Üí Z</option>
            <option value="alpha-desc">üî§ Z ‚Üí A</option>
            <option value="progress-asc">üí™ –°–ª–æ–∂–Ω—ã–µ</option>
            <option value="progress-desc">‚úÖ –õ—ë–≥–∫–∏–µ</option>
          </select>
        </div>
        <div id="words-grid" class="words-grid"></div>
        <div class="empty-state" id="empty-words" style="display: none">
          <div class="empty-icon">ü¶â</div>
          <h3>–°–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
          <p>–î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ ‚Äî –∏ –Ω–∞—á–Ω—ë–º —É—á–∏—Ç—å!</p>
          <br />
          <button class="btn btn-primary btn-lg" onclick="switchTab('add')">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞
          </button>
        </div>
      </div>

      <!-- TAB: ADD -->
      <div class="tab-pane" id="tab-add">
        <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞</div>
        <div class="add-layout">
          <div class="add-card">
            <h3>‚úèÔ∏è –û–¥–Ω–æ —Å–ª–æ–≤–æ</h3>
            <form id="single-form">
              <div class="form-group">
                <label>–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ *</label
                ><input
                  type="text"
                  id="f-en"
                  required
                  placeholder="e.g. achieve"
                />
              </div>
              <div class="form-group">
                <label>–ü–µ—Ä–µ–≤–æ–¥ *</label
                ><input
                  type="text"
                  id="f-ru"
                  required
                  placeholder="e.g. –¥–æ—Å—Ç–∏–≥–∞—Ç—å"
                />
              </div>
              <div class="form-group">
                <label>–ü—Ä–∏–º–µ—Ä (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label
                ><input
                  type="text"
                  id="f-ex"
                  placeholder="I want to achieve my goals"
                />
              </div>
              <div class="form-group">
                <label>–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</label
                ><input
                  type="text"
                  id="f-tags"
                  placeholder="verbs, important"
                />
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-lg"
                style="width: 100%"
              >
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ
              </button>
            </form>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1.5rem">
            <div class="add-card">
              <h3>üìã –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–º</h3>
              <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç: <code>—Å–ª–æ–≤–æ - –ø–µ—Ä–µ–≤–æ–¥</code></label>
                <textarea
                  id="bulk-text"
                  placeholder="achieve - –¥–æ—Å—Ç–∏–≥–∞—Ç—å&#10;boundary - –≥—Ä–∞–Ω–∏—Ü–∞&#10;challenge - –≤—ã–∑–æ–≤"
                ></textarea>
              </div>
              <div
                id="bulk-preview-wrap"
                style="display: none"
                class="preview-wrap"
              >
                <table class="preview-table">
                  <thead>
                    <tr>
                      <th>‚úì</th>
                      <th>English</th>
                      <th>–†—É—Å—Å–∫–∏–π</th>
                    </tr>
                  </thead>
                  <tbody id="bulk-tbody"></tbody>
                </table>
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem">
                <button class="btn btn-secondary" id="parse-bulk-btn">
                  üëÅ –ü—Ä–µ–≤—å—é
                </button>
                <button
                  class="btn btn-primary"
                  id="import-bulk-btn"
                  style="display: none"
                >
                  ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
              </div>
            </div>
            <div class="add-card">
              <h3>üìÇ –§–∞–π–ª (.csv / .xlsx)</h3>
              <div class="drop-zone" id="drop-zone">
                <div class="dz-icon">üìÅ</div>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                <p style="font-size: 0.8rem; margin-top: 0.3rem">
                  –ö–æ–ª–æ–Ω–∫–∏: A=English, B=–†—É—Å—Å–∫–∏–π, C=–ü—Ä–∏–º–µ—Ä
                </p>
              </div>
              <input
                type="file"
                id="file-input"
                accept=".csv,.xlsx"
                style="display: none"
              />
              <div
                id="file-preview-wrap"
                style="display: none; margin-top: 1rem"
                class="preview-wrap"
              >
                <table class="preview-table">
                  <thead>
                    <tr>
                      <th>‚úì</th>
                      <th>English</th>
                      <th>–†—É—Å—Å–∫–∏–π</th>
                      <th>–ü—Ä–∏–º–µ—Ä</th>
                    </tr>
                  </thead>
                  <tbody id="file-tbody"></tbody>
                </table>
              </div>
              <button
                class="btn btn-primary"
                id="import-file-btn"
                style="display: none; margin-top: 0.75rem; width: 100%"
              >
                ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: PRACTICE -->
      <div class="tab-pane" id="tab-practice">
        <div class="practice-wrap">
          <div class="setup-card" id="practice-setup">
            <h2>üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
            <div class="setup-row">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤</label>
              <div class="chip-group">
                <button class="chip on" data-count="5">5</button>
                <button class="chip" data-count="10">10</button>
                <button class="chip" data-count="20">20</button>
                <button class="chip" data-count="all">–í—Å–µ</button>
              </div>
            </div>
            <div class="setup-row">
              <label>–¢–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</label>
              <label class="check-row"
                ><input type="checkbox" data-ex="flash" checked /> üÉè
                –§–ª–µ—à-–∫–∞—Ä—Ç–æ—á–∫–∏</label
              >
              <label class="check-row"
                ><input type="checkbox" data-ex="multi" checked /> üéØ
                –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</label
              >
              <label class="check-row"
                ><input type="checkbox" data-ex="type" checked /> ‚å®Ô∏è –ù–∞–ø–∏—à–∏
                –ø–µ—Ä–µ–≤–æ–¥</label
              >
              <label class="check-row"
                ><input type="checkbox" data-ex="dictation" /> üîä –î–∏–∫—Ç–∞–Ω—Ç
                (—Å–ª—É—à–∞–π –∏ –ø–∏—à–∏)</label
              >
              <label class="check-row"
                ><input type="checkbox" data-ex="match" /> üß© –ù–∞–π–¥–∏ –ø–∞—Ä—ã
                (Match)</label
              >
            </div>
            <div class="setup-row">
              <label>–°–ª–æ–≤–∞ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏</label>
              <div class="chip-group">
                <button class="chip on" data-filter-w="all">–í—Å–µ</button>
                <button class="chip" data-filter-w="learning">
                  –¢–æ–ª—å–∫–æ —É—á—É
                </button>
                <button class="chip" data-filter-w="random">–°–ª—É—á–∞–π–Ω—ã–µ</button>
                <button class="chip" data-filter-w="due">
                  ‚è∞ –ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é <span class="due-pill" id="due-pill">0</span>
                </button>
              </div>
            </div>
            <div class="setup-row">
              <label>üîä –ê–≤—Ç–æ–ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ</label>
              <div class="chip-group">
                <button class="chip on" data-autopron="on">–í–∫–ª—é—á–µ–Ω–æ</button>
                <button class="chip" data-autopron="off">–í—ã–∫–ª—é—á–µ–Ω–æ</button>
              </div>
            </div>
            <div class="setup-row">
              <label>üîÑ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
              <div class="chip-group">
                <button class="chip on" data-dir="both">EN + RU</button>
                <button class="chip" data-dir="en-ru">EN ‚Üí RU</button>
                <button class="chip" data-dir="ru-en">RU ‚Üí EN</button>
              </div>
            </div>
            <button
              class="btn btn-primary btn-lg"
              id="start-btn"
              style="width: 100%; margin-top: 0.5rem"
            >
              üöÄ –ù–∞—á–∞—Ç—å!
            </button>
          </div>

          <div id="practice-ex" style="display: none">
            <div class="ex-wrap">
              <button class="ex-exit-btn" id="ex-exit-btn">‚úï –≤—ã–π—Ç–∏</button>
              <div class="ex-progress">
                <div class="ex-progress-info">
                  <span id="ex-counter">1 / 10</span>
                  <span id="ex-type-lbl"></span>
                </div>
                <div class="prog-bar">
                  <div class="prog-fill" id="prog-fill" style="width: 0%"></div>
                </div>
              </div>
              <div id="ex-content"></div>
              <div class="ex-btns" id="ex-btns"></div>
              <div class="hotkeys-hint" id="hotkeys-hint" style="display: none">
                <span class="hk"
                  ><kbd>Space</kbd>/<kbd>F</kbd> –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</span
                >
                <span class="hk"><kbd>Y</kbd>/<kbd>‚Üí</kbd> –ó–Ω–∞–ª</span>
                <span class="hk"><kbd>N</kbd>/<kbd>‚Üê</kbd> –ù–µ –∑–Ω–∞–ª</span>
                <span class="hk"><kbd>1‚Äì4</kbd> –≤—ã–±–æ—Ä</span>
                <span class="hk"><kbd>P</kbd> üîä</span>
              </div>
            </div>
          </div>

          <div id="practice-results" style="display: none">
            <div class="results-card">
              <div class="results-score" id="r-score">‚Äî</div>
              <div class="results-label" id="r-label">—Å–ª–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>
              <svg
                class="results-ring"
                width="130"
                height="130"
                id="r-ring"
                style="margin: 0 auto 1.5rem; display: block"
              ></svg>
              <div class="breakdown" id="r-breakdown">
                <div class="breakdown-col">
                  <h4>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ</h4>
                  <ul class="breakdown-list" id="r-correct"></ul>
                </div>
                <div class="breakdown-col">
                  <h4>‚ùå –û—à–∏–±–∫–∏</h4>
                  <ul class="breakdown-list" id="r-wrong"></ul>
                </div>
              </div>
              <div
                style="
                  display: flex;
                  gap: 0.75rem;
                  justify-content: center;
                  flex-wrap: wrap;
                "
              >
                <button class="btn btn-primary btn-lg" id="again-btn">
                  üîÑ –ï—â—ë —Ä–∞–∑
                </button>
                <button class="btn btn-secondary btn-lg" id="setup-btn">
                  ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: STATS -->
      <div class="tab-pane" id="tab-stats">
        <div class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-num" id="st-total">0</div>
            <div class="stat-lbl">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="st-learned">0</div>
            <div class="stat-lbl">–í—ã—É—á–µ–Ω–æ</div>
            <div class="stat-prog">
              <div
                class="stat-prog-fill"
                id="st-learned-bar"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="st-streak">0</div>
            <div class="stat-lbl">üî• –î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="st-week">0</div>
            <div class="stat-lbl">–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
          </div>
          <div class="stat-card srs-hl">
            <div class="stat-num" id="st-due" style="color: var(--danger)">
              0
            </div>
            <div class="stat-lbl">‚è∞ –ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</div>
          </div>
        </div>
        <div class="sparkline-wrap">
          <h3>üìÖ –°–ª–æ–≤–∞ –ø–æ –¥–Ω—è–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)</h3>
          <svg
            class="spark-svg"
            id="spark-svg"
            viewBox="0 0 400 80"
            preserveAspectRatio="none"
          ></svg>
          <div class="spark-labels" id="spark-labels"></div>
        </div>

        <!-- XP + Badges -->
        <div class="xp-stats-row">
          <div>
            <div class="xp-big" id="st-level">–£—Ä–æ–≤–µ–Ω—å 1</div>
            <div class="xp-sub">–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</div>
          </div>
          <div>
            <div class="xp-big" id="st-xp" style="font-size: 1.2rem">
              0/100 XP
            </div>
            <div class="xp-sub">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div>
          </div>
        </div>
        <div class="badges-section">
          <h3>üèÖ –ë–µ–π–¥–∂–∏</h3>
          <div class="badges-grid" id="badges-grid"></div>
        </div>

        <!-- Speech settings in stats -->
        <div class="speech-settings">
          <h3>üîä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è</h3>
          <div id="no-speech-stats" class="no-speech" style="display: none">
            –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º
          </div>
          <div id="speech-controls">
            <div class="speech-row" style="margin-bottom: 0.75rem">
              <label>–ì–æ–ª–æ—Å</label>
              <select id="voice-select"></select>
            </div>
            <div class="speech-row" style="margin-bottom: 0.75rem">
              <label>–°–∫–æ—Ä–æ—Å—Ç—å</label>
              <input
                type="range"
                id="speed-range"
                min="0.5"
                max="1.5"
                step="0.1"
                value="0.9"
              />
              <span id="speed-val" style="font-weight: 700; min-width: 30px"
                >0.9x</span
              >
            </div>
            <div class="speech-row" style="margin-bottom: 0.75rem">
              <label>–í—ã—Å–æ—Ç–∞</label>
              <input
                type="range"
                id="pitch-range"
                min="0.5"
                max="2"
                step="0.1"
                value="1"
              />
              <span id="pitch-val" style="font-weight: 700; min-width: 30px"
                >1.0</span
              >
            </div>
            <div class="voice-test">
              <button class="btn btn-secondary" id="test-voice-btn">
                üîä –¢–µ—Å—Ç –≥–æ–ª–æ—Å–∞
              </button>
              <span
                style="
                  color: var(--muted);
                  font-size: 0.85rem;
                  font-weight: 600;
                "
                >–ø–æ—Å–ª—É—à–∞–π –∫–∞–∫ –∑–≤—É—á–∏—Ç</span
              >
            </div>
          </div>
        </div>

        <div class="word-lists">
          <div class="word-list-card">
            <h3>üí™ –¢–æ–ø-5 —Å–ª–æ–∂–Ω—ã—Ö</h3>
            <ul class="wlist" id="st-hard"></ul>
          </div>
          <div class="word-list-card">
            <h3>üåü –¢–æ–ø-5 –ª—ë–≥–∫–∏—Ö</h3>
            <ul class="wlist" id="st-easy"></ul>
          </div>
        </div>
      </div>
    </main>

    <div class="modal-backdrop" id="del-modal">
      <div class="modal-box">
        <h3>–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ?</h3>
        <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="del-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-danger" id="del-confirm">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div id="toast-box"></div>

    <!-- Import/Export Modal -->
    <div class="io-modal-overlay" id="io-modal">
      <div class="io-modal">
        <h3 id="io-modal-title">üì¶ –ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</h3>
        <div id="io-export-view">
          <div class="io-btn-group">
            <button class="io-btn" id="io-export-json">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø (JSON)
              <span class="io-btn-sub"
                >–í—Å–µ —Å–ª–æ–≤–∞ + SRS –ø—Ä–æ–≥—Ä–µ—Å—Å + XP + –±–µ–π–¥–∂–∏</span
              >
            </button>
            <button class="io-btn" id="io-export-csv">
              üìÑ –≠–∫—Å–ø–æ—Ä—Ç —Å–ª–æ–≤ –≤ CSV
              <span class="io-btn-sub"
                >–¢–æ–ª—å–∫–æ —Å–ª–æ–≤–∞: –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ä—É—Å—Å–∫–∏–π, –ø—Ä–∏–º–µ—Ä, —Ç–µ–≥–∏</span
              >
            </button>
            <button class="io-btn" id="io-export-anki">
              üÉè –≠–∫—Å–ø–æ—Ä—Ç –≤ Anki (TSV)
              <span class="io-btn-sub"
                >–°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Anki: Import ‚Üí Fields separated by Tab</span
              >
            </button>
            <button class="io-btn" id="io-to-import">
              ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞...
              <span class="io-btn-sub">–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON-–±—ç–∫–∞–ø –∏–ª–∏ CSV-—Ñ–∞–π–ª</span>
            </button>
          </div>
          <button class="io-close" id="io-close-export">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div id="io-import-view" style="display: none">
          <div class="io-drop-zone" id="io-drop-zone">
            üóÇÔ∏è –ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª —Å—é–¥–∞<br />–∏–ª–∏ –Ω–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞<br />
            <span style="font-size: 0.75rem; margin-top: 0.3rem; display: block"
              >–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: .json (–±—ç–∫–∞–ø) ¬∑ .csv (—Å–ª–æ–≤–∞)</span
            >
          </div>
          <input
            type="file"
            id="io-file-input"
            accept=".json,.csv"
            style="display: none"
          />
          <div
            id="io-import-info"
            style="
              font-size: 0.8rem;
              color: var(--muted);
              margin-bottom: 0.75rem;
              display: none;
            "
          ></div>
          <div
            class="io-btn-group"
            id="io-import-actions"
            style="display: none"
          >
            <button class="io-btn" id="io-confirm-import">
              ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–º–ø–æ—Ä—Ç
            </button>
          </div>
          <button class="io-close" id="io-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // DATA
      // ============================================================
      const SK = 'vocabmaster_v1';
      const XP_K = 'vocabmaster_xp';
      const STREAK_K = 'vocabmaster_streak';
      const SPEECH_K = 'vocabmaster_speech';
      let words = [];
      let streak = { count: 0, lastDate: null };
      let speechCfg = { voiceURI: '', rate: 0.9, pitch: 1.0 };
      let xpData = { xp: 0, level: 1, badges: [] };

      function load() {
        try {
          words = JSON.parse(localStorage.getItem(SK)) || [];
          words.forEach(w => {
            if (!w.stats.nextReview) {
              w.stats.nextReview = new Date().toISOString();
              w.stats.interval = 1;
              w.stats.easeFactor = 2.5;
            }
          });
        } catch (e) {
          words = [];
        }
        try {
          streak = JSON.parse(localStorage.getItem(STREAK_K)) || {
            count: 0,
            lastDate: null,
          };
        } catch (e) {}
        try {
          const s = JSON.parse(localStorage.getItem(SPEECH_K));
          if (s) speechCfg = s;
        } catch (e) {}
        try {
          const x = JSON.parse(localStorage.getItem(XP_K));
          if (x) xpData = x;
        } catch (e) {}
      }
      function save() {
        localStorage.setItem(SK, JSON.stringify(words));
      }
      function saveXP() {
        localStorage.setItem(XP_K, JSON.stringify(xpData));
      }
      function saveStreak() {
        localStorage.setItem(STREAK_K, JSON.stringify(streak));
      }
      function saveSpeech() {
        localStorage.setItem(SPEECH_K, JSON.stringify(speechCfg));
      }

      function mkWord(en, ru, ex, tags) {
        return {
          id: crypto.randomUUID(),
          en: en.trim(),
          ru: ru.trim(),
          ex: (ex || '').trim(),
          tags: tags || [],
          createdAt: new Date().toISOString(),
          stats: {
            shown: 0,
            correct: 0,
            streak: 0,
            lastPracticed: null,
            learned: false,
            nextReview: new Date().toISOString(),
            interval: 1,
            easeFactor: 2.5,
          },
        };
      }
      function addWord(en, ru, ex, tags) {
        if (words.some(w => w.en.toLowerCase() === en.trim().toLowerCase())) {
          toast('‚ö†Ô∏è –°–ª–æ–≤–æ ¬´' + en.trim() + '¬ª —É–∂–µ –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ', 'warning');
          return false;
        }
        words.push(mkWord(en, ru, ex, tags));
        save();
        import('./db.js').then(({ saveWordToDb }) =>
          saveWordToDb(words[words.length - 1]),
        );
        gainXP(15, '–Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ');
        checkBadges();
        return true;
      }
      function delWord(id) {
        words = words.filter(w => w.id !== id);
        save();
        import('./db.js').then(({ deleteWordFromDb }) => deleteWordFromDb(id));
      }
      function updWord(id, data) {
        const w = words.find(w => w.id === id);
        if (w) {
          Object.assign(w, data);
          save();
          import('./db.js').then(({ saveWordToDb }) => saveWordToDb(w));
        }
      }
      function updStats(id, correct) {
        const w = words.find(w => w.id === id);
        if (!w) return;
        w.stats.shown++;
        w.stats.lastPracticed = new Date().toISOString();
        if (correct) {
          w.stats.correct++;
          w.stats.streak++;
          w.stats.easeFactor = Math.max(1.3, w.stats.easeFactor + 0.1);
          if (w.stats.interval <= 1) {
            w.stats.interval = 3;
          } else if (w.stats.interval <= 3) {
            w.stats.interval = 7;
          } else {
            w.stats.interval = Math.round(
              w.stats.interval * w.stats.easeFactor,
            );
          }
        } else {
          w.stats.streak = 0;
          w.stats.interval = 1;
          w.stats.easeFactor = Math.max(1.3, w.stats.easeFactor - 0.2);
        }
        const next = new Date();
        next.setDate(next.getDate() + w.stats.interval);
        w.stats.nextReview = next.toISOString();
        const wasLearned = w.stats.learned;
        w.stats.learned = w.stats.streak >= 3;
        if (!wasLearned && w.stats.learned) {
          gainXP(50, '—Å–ª–æ–≤–æ –≤—ã—É—á–µ–Ω–æ üåü');
          checkBadges();
        }
        save();
      }

      // ============================================================
      // XP + BADGES
      // ============================================================
      const XP_PER_LEVEL = 100;

      const BADGES_DEF = [
        {
          id: 'first_word',
          icon: 'üå±',
          name: '–ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ',
          desc: '–î–æ–±–∞–≤—å 1 —Å–ª–æ–≤–æ',
          check: () => words.length >= 1,
        },
        {
          id: 'words_10',
          icon: 'üìö',
          name: '–ù–∞—á–∏–Ω–∞—é—â–∏–π',
          desc: '10 —Å–ª–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ',
          check: () => words.length >= 10,
        },
        {
          id: 'words_50',
          icon: 'üìñ',
          name: '–ß–∏—Ç–∞—Ç–µ–ª—å',
          desc: '50 —Å–ª–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ',
          check: () => words.length >= 50,
        },
        {
          id: 'words_100',
          icon: 'üèÜ',
          name: '–°–ª–æ–≤–∞—Ä—å',
          desc: '100 —Å–ª–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ',
          check: () => words.length >= 100,
        },
        {
          id: 'learned_1',
          icon: '‚≠ê',
          name: '–ü–µ—Ä–≤—ã–π —É—Å–ø–µ—Ö',
          desc: '–í—ã—É—á–∏ 1 —Å–ª–æ–≤–æ',
          check: () => words.filter(w => w.stats.learned).length >= 1,
        },
        {
          id: 'learned_10',
          icon: 'üåü',
          name: '–£—Å–µ—Ä–¥–Ω—ã–π',
          desc: '–í—ã—É—á–∏ 10 —Å–ª–æ–≤',
          check: () => words.filter(w => w.stats.learned).length >= 10,
        },
        {
          id: 'learned_50',
          icon: 'üí´',
          name: '–ú–∞—Å—Ç–µ—Ä —Å–ª–æ–≤',
          desc: '–í—ã—É—á–∏ 50 —Å–ª–æ–≤',
          check: () => words.filter(w => w.stats.learned).length >= 50,
        },
        {
          id: 'streak_3',
          icon: 'üî•',
          name: '–ù–∞ –æ–≥–Ω–µ',
          desc: '3 –¥–Ω—è –ø–æ–¥—Ä—è–¥',
          check: () => streak.count >= 3,
        },
        {
          id: 'streak_7',
          icon: 'üöÄ',
          name: '–ù–µ–¥–µ–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏',
          desc: '7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥',
          check: () => streak.count >= 7,
        },
        {
          id: 'streak_30',
          icon: 'üëë',
          name: '–õ–µ–≥–µ–Ω–¥–∞',
          desc: '30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥',
          check: () => streak.count >= 30,
        },
        {
          id: 'xp_500',
          icon: 'üíé',
          name: '–ê–ª–º–∞–∑–Ω—ã–π',
          desc: '–ù–∞–±–µ—Ä–∏ 500 XP',
          check: () => xpData.xp + (xpData.level - 1) * XP_PER_LEVEL >= 500,
        },
        {
          id: 'xp_1000',
          icon: 'üéñÔ∏è',
          name: '–í–µ—Ç–µ—Ä–∞–Ω',
          desc: '–ù–∞–±–µ—Ä–∏ 1000 XP',
          check: () => xpData.xp + (xpData.level - 1) * XP_PER_LEVEL >= 1000,
        },
        {
          id: 'perfect',
          icon: 'üéØ',
          name: '–°–Ω–∞–π–ø–µ—Ä',
          desc: '–°–µ—Å—Å–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫ (5+ —Å–ª–æ–≤)',
          check: () => false,
        },
        {
          id: 'level_5',
          icon: '‚ö°',
          name: '–ü—Ä–æ–∫–∞—á–∞–Ω',
          desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 5 —É—Ä–æ–≤–Ω—è',
          check: () => xpData.level >= 5,
        },
        {
          id: 'level_10',
          icon: 'ü¶Ö',
          name: '–û—Ä—ë–ª',
          desc: '–î–æ—Å—Ç–∏–≥–Ω–∏ 10 —É—Ä–æ–≤–Ω—è',
          check: () => xpData.level >= 10,
        },
      ];

      function xpNeeded(lvl) {
        return lvl * XP_PER_LEVEL;
      }

      function gainXP(amount, reason = '') {
        xpData.xp += amount;
        while (xpData.xp >= xpNeeded(xpData.level)) {
          xpData.xp -= xpNeeded(xpData.level);
          xpData.level++;
          showLevelUpBanner(xpData.level);
        }
        saveXP();
        renderXP();
        showXPToast('+' + amount + ' XP' + (reason ? ' ¬∑ ' + reason : ''));
      }

      function checkBadges(perfectSession) {
        let newBadges = [];
        BADGES_DEF.forEach(def => {
          if (xpData.badges.includes(def.id)) return;
          const earned = def.id === 'perfect' ? !!perfectSession : def.check();
          if (earned) {
            xpData.badges.push(def.id);
            newBadges.push(def);
          }
        });
        if (newBadges.length) {
          saveXP();
          newBadges.forEach((b, i) =>
            setTimeout(
              () => toast(b.icon + ' –ë–µ–π–¥–∂: ¬´' + b.name + '¬ª!', 'success'),
              i * 600,
            ),
          );
          renderBadges();
        }
      }

      function showXPToast(msg) {
        const el = document.createElement('div');
        el.className = 'xp-toast';
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2800);
      }

      function showLevelUpBanner(lvl) {
        const el = document.createElement('div');
        el.className = 'level-up-banner';
        el.innerHTML =
          'üéâ –£—Ä–æ–≤–µ–Ω—å ' +
          lvl +
          '!<br><span style="font-size:.85rem;font-weight:600;opacity:.9">–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!</span>';
        document.body.appendChild(el);
        setTimeout(() => {
          el.style.transition = 'transform .4s ease, opacity .4s ease';
          el.style.transform = 'translate(-50%,-50%) scale(0)';
          el.style.opacity = '0';
          setTimeout(() => el.remove(), 400);
        }, 2200);
      }

      function renderXP() {
        const needed = xpNeeded(xpData.level);
        const pct = Math.min(100, Math.round((xpData.xp / needed) * 100));
        const fill = document.getElementById('xp-bar-fill');
        const num = document.getElementById('xp-num');
        const lvl = document.getElementById('xp-level-lbl');
        if (fill) fill.style.width = pct + '%';
        if (num) num.textContent = xpData.xp + '/' + needed;
        if (lvl) lvl.textContent = '‚ö° –£—Ä. ' + xpData.level;
        const stXP = document.getElementById('st-xp');
        const stLvl = document.getElementById('st-level');
        if (stXP) stXP.textContent = xpData.xp + ' / ' + needed + ' XP';
        if (stLvl) stLvl.textContent = '–£—Ä–æ–≤–µ–Ω—å ' + xpData.level;
      }

      function renderBadges() {
        const grid = document.getElementById('badges-grid');
        if (!grid) return;
        grid.innerHTML = BADGES_DEF.map(def => {
          const ok = xpData.badges.includes(def.id);
          return (
            '<div class="badge-card ' +
            (ok ? 'unlocked' : 'locked') +
            '">' +
            '<div class="badge-icon">' +
            def.icon +
            '</div>' +
            '<div class="badge-name">' +
            def.name +
            '</div>' +
            '<div class="badge-desc">' +
            def.desc +
            '</div></div>'
          );
        }).join('');
      }

      function updStreak() {
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        if (streak.lastDate === today) return;
        if (streak.lastDate === yesterday) streak.count++;
        else streak.count = 1;
        streak.lastDate = today;
        saveStreak();
      }

      // ============================================================
      // SPEECH ENGINE
      // ============================================================
      const synth = window.speechSynthesis;
      let voices = [];
      let speechSupported = !!synth;

      function loadVoices() {
        voices = synth ? synth.getVoices() : [];
        const englishVoices = voices.filter(v => v.lang.startsWith('en'));
        const sel = document.getElementById('voice-select');
        sel.innerHTML = '';
        (englishVoices.length ? englishVoices : voices).forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})`;
          if (v.voiceURI === speechCfg.voiceURI) opt.selected = true;
          sel.appendChild(opt);
        });
        if (!sel.value && sel.options.length) {
          speechCfg.voiceURI = sel.options[0].value;
        }
      }

      if (synth) {
        synth.onvoiceschanged = loadVoices;
        loadVoices();
      } else {
        document.getElementById('no-speech-banner').style.display = 'block';
        document.getElementById('no-speech-stats').style.display = 'block';
        document.getElementById('speech-controls').style.display = 'none';
      }

      function speak(text, onEnd) {
        if (!speechSupported || !text) return;
        synth.cancel();
        const utt = new SpeechSynthesisUtterance(text);
        utt.lang = 'en-US';
        const voice = voices.find(v => v.voiceURI === speechCfg.voiceURI);
        if (voice) utt.voice = voice;
        utt.rate = speechCfg.rate;
        utt.pitch = speechCfg.pitch;
        if (onEnd) utt.onend = onEnd;
        synth.speak(utt);
      }

      function speakBtn(text, btn) {
        if (!speechSupported) return;
        const wasActive = btn.classList.contains('speaking');
        if (wasActive) {
          synth.cancel();
          btn.classList.remove('speaking');
          btn.textContent = 'üîä';
          return;
        }
        btn.classList.add('speaking');
        btn.innerHTML =
          '<div class="audio-wave"><span></span><span></span><span></span><span></span><span></span></div>';
        speak(text, () => {
          btn.classList.remove('speaking');
          btn.textContent = 'üîä';
        });
      }

      // Speech settings UI
      document.getElementById('voice-select').addEventListener('change', e => {
        speechCfg.voiceURI = e.target.value;
        saveSpeech();
      });
      document.getElementById('speed-range').addEventListener('input', e => {
        speechCfg.rate = +e.target.value;
        document.getElementById('speed-val').textContent = e.target.value + 'x';
        saveSpeech();
      });
      document.getElementById('pitch-range').addEventListener('input', e => {
        speechCfg.pitch = +e.target.value;
        document.getElementById('pitch-val').textContent = (+e.target
          .value).toFixed(1);
        saveSpeech();
      });
      document
        .getElementById('test-voice-btn')
        .addEventListener('click', function () {
          const btn = this;
          const orig = btn.innerHTML;
          btn.innerHTML =
            '<div class="audio-wave"><span></span><span></span><span></span><span></span><span></span></div>';
          btn.disabled = true;
          speak('Hello! This is a voice test. How are you doing today?', () => {
            btn.innerHTML = orig;
            btn.disabled = false;
          });
        });
      document.getElementById('speed-range').value = speechCfg.rate;
      document.getElementById('speed-val').textContent = speechCfg.rate + 'x';
      document.getElementById('pitch-range').value = speechCfg.pitch;
      document.getElementById('pitch-val').textContent =
        speechCfg.pitch.toFixed(1);

      // ============================================================
      // TOAST
      // ============================================================
      function toast(msg, type = '') {
        const el = document.createElement('div');
        el.className = 'toast' + (type ? ' ' + type : '');
        el.textContent = msg;
        document.getElementById('toast-box').appendChild(el);
        setTimeout(() => {
          el.style.opacity = '0';
          el.style.transition = 'opacity .3s';
          setTimeout(() => el.remove(), 320);
        }, 2600);
      }

      // ============================================================
      // TABS
      // ============================================================
      function switchTab(name) {
        if (name === 'words') {
          setTimeout(renderWotd, 0);
          updateDueBadge();
        }
        if (name === 'practice') {
          renderStats();
        }
        document
          .querySelectorAll('.nav-btn')
          .forEach(b => b.classList.toggle('active', b.dataset.tab === name));
        document
          .querySelectorAll('.tab-pane')
          .forEach(p => p.classList.toggle('active', p.id === 'tab-' + name));
        if (name === 'stats') renderStats();
        if (name === 'words') renderWords();
      }
      document
        .querySelectorAll('.nav-btn[data-tab]')
        .forEach(b =>
          b.addEventListener('click', () => switchTab(b.dataset.tab)),
        );

      // ============================================================
      // DARK MODE
      // ============================================================
      function applyDark(on) {
        document.body.classList.toggle('dark', on);
        document.getElementById('dark-toggle').textContent = on ? '‚òÄÔ∏è' : 'üåô';
      }
      document.getElementById('dark-toggle').addEventListener('click', () => {
        const on = !document.body.classList.contains('dark');
        localStorage.setItem('vmDark', on);
        applyDark(on);
      });
      if (localStorage.getItem('vmDark') === 'true') applyDark(true);

      // ============================================================
      // RENDER WORDS
      // ============================================================
      let activeFilter = 'all',
        searchQ = '',
        sortBy = 'date-desc',
        tagFilter = '';

      function renderWords() {
        const grid = document.getElementById('words-grid');
        const empty = document.getElementById('empty-words');
        let list = words;
        if (activeFilter === 'learning')
          list = list.filter(w => !w.stats.learned);
        if (activeFilter === 'learned')
          list = list.filter(w => w.stats.learned);
        if (searchQ) {
          const q = searchQ.toLowerCase();
          list = list.filter(
            w =>
              w.en.toLowerCase().includes(q) ||
              w.ru.toLowerCase().includes(q) ||
              w.tags.some(t => t.toLowerCase().includes(q)),
          );
        }
        if (tagFilter)
          list = list.filter(w =>
            w.tags.map(t => t.toLowerCase()).includes(tagFilter),
          );
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        if (sortBy === 'date-asc')
          list = [...list].sort((a, b) =>
            a.createdAt.localeCompare(b.createdAt),
          );
        else if (sortBy === 'date-desc')
          list = [...list].sort((a, b) =>
            b.createdAt.localeCompare(a.createdAt),
          );
        else if (sortBy === 'alpha-asc')
          list = [...list].sort((a, b) => a.en.localeCompare(b.en));
        else if (sortBy === 'alpha-desc')
          list = [...list].sort((a, b) => b.en.localeCompare(a.en));
        else if (sortBy === 'progress-asc')
          list = [...list].sort(
            (a, b) =>
              (a.stats.shown ? a.stats.correct / a.stats.shown : 1) -
              (b.stats.shown ? b.stats.correct / b.stats.shown : 1),
          );
        else if (sortBy === 'progress-desc')
          list = [...list].sort(
            (a, b) =>
              (b.stats.shown ? b.stats.correct / b.stats.shown : 1) -
              (a.stats.shown ? a.stats.correct / a.stats.shown : 1),
          );

        document.getElementById('words-count').textContent = words.length;
        updateDueBadge();
        document.getElementById('words-subtitle').textContent =
          list.length !== words.length
            ? `(${list.length} –∏–∑ ${words.length})`
            : `‚Äî ${words.length} —Å–ª–æ–≤`;
        if (!list.length) {
          grid.innerHTML = '';
          empty.style.display = 'block';
          return;
        }
        empty.style.display = 'none';
        grid.innerHTML = '';
        let tagInd = document.getElementById('tag-filter-indicator');
        if (tagFilter) {
          if (!tagInd) {
            tagInd = document.createElement('div');
            tagInd.id = 'tag-filter-indicator';
            grid.parentNode.insertBefore(tagInd, grid);
          }
          tagInd.innerHTML = `<span class="tag-filter-indicator">üè∑ ${esc(tagFilter)} &nbsp;‚úï –æ—á–∏—Å—Ç–∏—Ç—å</span>`;
          tagInd.querySelector('.tag-filter-indicator').onclick = () => {
            tagFilter = '';
            renderWords();
          };
        } else {
          if (tagInd) tagInd.remove();
        }
        list.forEach(w => grid.appendChild(makeCard(w)));
      }

      function makeCard(w) {
        const card = document.createElement('div');
        card.className = 'word-card';
        card.dataset.id = w.id;
        card.innerHTML = `
    <div class="wc-top">
      <div class="wc-english">${esc(w.en)}</div>
      ${speechSupported ? `<button class="btn-audio audio-card-btn" data-word="${esc(w.en)}" title="–ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏">üîä</button>` : ''}
    </div>
    <div class="wc-russian">${esc(w.ru)}</div>
    ${w.ex ? `<div class="wc-example">${esc(w.ex)}</div>` : ''}
    <div class="wc-footer">
      <div class="wc-streak">${[0, 1, 2].map(i => `<div class="dot${w.stats.streak > i ? ' on' : ''}"></div>`).join('')}</div>
      <div class="wc-badges">
        ${
          w.stats.learned
            ? '<span class="badge-learned">‚úÖ –í—ã—É—á–µ–Ω–æ</span>'
            : (() => {
                const now = new Date();
                const next = new Date(w.stats.nextReview || now);
                const diff = Math.round((next - now) / 86400000);
                if (diff <= 0)
                  return '<span class="due-now">‚è∞ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å!</span>';
                if (diff === 1)
                  return '<span class="due-soon">üìÖ –ó–∞–≤—Ç—Ä–∞</span>';
                return `<span class="due-later">üìÖ —á–µ—Ä–µ–∑ ${diff}–¥</span>`;
              })()
        }
        ${w.tags.map(t => `<span class="badge-tag tag-filter-btn" data-tag="${esc(t)}">${esc(t)}</span>`).join('')}
      </div>
    </div>
    <div class="srs-meta">–ò–Ω—Ç–µ—Ä–≤–∞–ª: ${w.stats.interval || 1}–¥ &middot; –õ—ë–≥–∫–æ—Å—Ç—å: ${(w.stats.easeFactor || 2.5).toFixed(1)}</div>
    <div class="wc-actions">
      <button class="btn btn-secondary btn-sm edit-btn" data-id="${w.id}">‚úèÔ∏è –†–µ–¥.</button>
      <button class="btn btn-danger btn-sm del-btn" data-id="${w.id}">üóë</button>
    </div>
  `;
        return card;
      }

      function esc(s) {
        return String(s || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      // Audio buttons on word cards
      document.getElementById('words-grid').addEventListener('click', e => {
        if (
          e.target.classList.contains('audio-card-btn') ||
          e.target.closest('.audio-card-btn')
        ) {
          const btn = e.target.classList.contains('audio-card-btn')
            ? e.target
            : e.target.closest('.audio-card-btn');
          speakBtn(btn.dataset.word, btn);
          return;
        }
        const id = e.target.dataset.id;
        if (!id) return;
        if (e.target.classList.contains('del-btn')) {
          pendingDelId = id;
          document.getElementById('del-modal').classList.add('open');
        }
        if (e.target.classList.contains('edit-btn')) {
          const w = words.find(x => x.id === id);
          if (!w) return;
          const card = e.target.closest('.word-card');
          card.classList.add('editing');
          card.innerHTML = `
      <div class="form-group"><label>English</label><input type="text" class="e-en" value="${esc(w.en)}"></div>
      <div class="form-group"><label>–†—É—Å—Å–∫–∏–π</label><input type="text" class="e-ru" value="${esc(w.ru)}"></div>
      <div class="form-group"><label>–ü—Ä–∏–º–µ—Ä</label><input type="text" class="e-ex" value="${esc(w.ex)}"></div>
      <div class="form-group"><label>–¢–µ–≥–∏</label><input type="text" class="e-tags" value="${esc(w.tags.join(', '))}"></div>
      <div style="display:flex;gap:.5rem">
        <button class="btn btn-primary save-edit" data-id="${id}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary cancel-edit">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `;
          card.querySelector('.save-edit').addEventListener('click', () => {
            updWord(id, {
              en: card.querySelector('.e-en').value.trim(),
              ru: card.querySelector('.e-ru').value.trim(),
              ex: card.querySelector('.e-ex').value.trim(),
              tags: card
                .querySelector('.e-tags')
                .value.split(',')
                .map(t => t.trim())
                .filter(Boolean),
            });
            toast('‚úÖ –°–ª–æ–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
            renderWords();
          });
          card
            .querySelector('.cancel-edit')
            .addEventListener('click', () => renderWords());
        }
      });

      // Pills & search
      document.querySelectorAll('.pill').forEach(p =>
        p.addEventListener('click', () => {
          document
            .querySelectorAll('.pill')
            .forEach(x => x.classList.remove('active'));
          p.classList.add('active');
          activeFilter = p.dataset.filter;
          renderWords();
        }),
      );
      document.getElementById('sort-select').addEventListener('change', e => {
        sortBy = e.target.value;
        renderWords();
      });
      document.getElementById('words-grid').addEventListener('click', e => {
        const tb = e.target.closest('.tag-filter-btn');
        if (!tb) return;
        e.stopPropagation();
        const tag = tb.dataset.tag.toLowerCase();
        tagFilter = tagFilter === tag ? '' : tag;
        renderWords();
      });
      let searchTimer;
      document.getElementById('search-input').addEventListener('input', e => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          searchQ = e.target.value;
          renderWords();
        }, 280);
      });

      // Delete modal
      let pendingDelId = null;
      document.getElementById('del-confirm').addEventListener('click', () => {
        if (pendingDelId) {
          const wSnap = words.find(w => w.id === pendingDelId);
          delWord(pendingDelId);
          pendingDelId = null;
          renderWords();
          // Undo toast
          const undoEl = document.createElement('div');
          undoEl.className = 'toast warning toast-undo';
          undoEl.innerHTML =
            '<span>üóë ¬´' +
            esc(wSnap ? wSnap.en : '–°–ª–æ–≤–æ') +
            '¬ª —É–¥–∞–ª–µ–Ω–æ</span>' +
            '<button class="toast-undo-btn">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å</button>';
          document.getElementById('toast-box').appendChild(undoEl);
          let undone = false;
          undoEl
            .querySelector('.toast-undo-btn')
            .addEventListener('click', () => {
              undone = true;
              if (wSnap) {
                words.push(wSnap);
                save();
                renderWords();
              }
              undoEl.remove();
              toast('‚Ü©Ô∏è ¬´' + wSnap.en + '¬ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
            });
          setTimeout(() => {
            if (!undone) {
              undoEl.style.opacity = '0';
              undoEl.style.transition = 'opacity .3s';
              setTimeout(() => undoEl.remove(), 320);
            }
          }, 5000);
        }
        document.getElementById('del-modal').classList.remove('open');
      });
      document
        .getElementById('del-cancel')
        .addEventListener('click', () =>
          document.getElementById('del-modal').classList.remove('open'),
        );

      // ============================================================
      // ADD WORDS
      // ============================================================
      document.getElementById('single-form').addEventListener('submit', e => {
        e.preventDefault();
        const en = document.getElementById('f-en').value.trim();
        const ru = document.getElementById('f-ru').value.trim();
        if (!en || !ru) return;
        addWord(
          en,
          ru,
          document.getElementById('f-ex').value.trim(),
          document
            .getElementById('f-tags')
            .value.split(',')
            .map(t => t.trim())
            .filter(Boolean),
        );
        e.target.reset();
        document.getElementById('f-en').focus();
        toast(`‚úÖ ¬´${en}¬ª –¥–æ–±–∞–≤–ª–µ–Ω–æ!`, 'success');
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–æ–≤–∞—Ä—å —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
        switchTab('words');
        setTimeout(() => {
          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ‚Äî –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ –ø–µ—Ä–≤—ã–º
          const sel = document.getElementById('sort-select');
          if (sel && sel.value !== 'date-desc') {
            sel.value = 'date-desc';
            sortBy = 'date-desc';
          }
          renderWords();
          setTimeout(() => {
            const newCard = document.querySelector('#words-grid .word-card');
            if (newCard) {
              newCard.classList.add('word-card--new');
              newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              setTimeout(() => newCard.classList.remove('word-card--new'), 700);
            }
          }, 60);
        }, 50);
      });

      let bulkParsed = [];
      document
        .getElementById('parse-bulk-btn')
        .addEventListener('click', () => {
          const lines = document
            .getElementById('bulk-text')
            .value.split('\n')
            .filter(l => l.trim());
          bulkParsed = lines
            .map(l => {
              const parts = l.split('-').map(p => p.trim());
              return { en: parts[0] || '', ru: parts[1] || '' };
            })
            .filter(w => w.en && w.ru);
          const tbody = document.getElementById('bulk-tbody');
          tbody.innerHTML = bulkParsed
            .map(
              (w, i) =>
                `<tr><td><input type="checkbox" class="bchk" data-i="${i}" checked></td><td>${esc(w.en)}</td><td>${esc(w.ru)}</td></tr>`,
            )
            .join('');
          document.getElementById('bulk-preview-wrap').style.display =
            bulkParsed.length ? 'block' : 'none';
          document.getElementById('import-bulk-btn').style.display =
            bulkParsed.length ? 'inline-flex' : 'none';
          document.getElementById('import-bulk-btn').textContent =
            `‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${bulkParsed.length} —Å–ª–æ–≤`;
        });
      document
        .getElementById('import-bulk-btn')
        .addEventListener('click', () => {
          const checked = [...document.querySelectorAll('.bchk:checked')].map(
            c => +c.dataset.i,
          );
          checked.forEach(i =>
            addWord(bulkParsed[i].en, bulkParsed[i].ru, '', []),
          );
          document.getElementById('bulk-preview-wrap').style.display = 'none';
          document.getElementById('import-bulk-btn').style.display = 'none';
          document.getElementById('bulk-text').value = '';
          bulkParsed = [];
          toast(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${checked.length} —Å–ª–æ–≤!`);
          renderWords();
          switchTab('words');
        });

      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('over');
      });
      dropZone.addEventListener('dragleave', () =>
        dropZone.classList.remove('over'),
      );
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('over');
        if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener('change', e => {
        if (e.target.files[0]) handleFile(e.target.files[0]);
      });

      let fileParsed = [];
      function handleFile(file) {
        const showPreview = () => {
          const tbody = document.getElementById('file-tbody');
          tbody.innerHTML = fileParsed
            .map(
              (w, i) =>
                `<tr><td><input type="checkbox" class="fchk" data-i="${i}" ${words.find(x => x.en.toLowerCase() === w.en.toLowerCase()) ? '' : 'checked'}></td>` +
                `<td>${esc(w.en)}${words.find(x => x.en.toLowerCase() === w.en.toLowerCase()) ? ` <span style="color:var(--warning);font-size:.75rem">‚ö†Ô∏è —É–∂–µ –µ—Å—Ç—å</span>` : ''}</td>` +
                `<td>${esc(w.ru)}</td><td>${esc(w.ex)}</td></tr>`,
            )
            .join('');
          document.getElementById('file-preview-wrap').style.display =
            fileParsed.length ? 'block' : 'none';
          const btn = document.getElementById('import-file-btn');
          const newCount = fileParsed.filter(
            w => !words.find(x => x.en.toLowerCase() === w.en.toLowerCase()),
          ).length;
          btn.style.display = fileParsed.length ? 'block' : 'none';
          btn.textContent = `‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${newCount} –Ω–æ–≤—ã—Ö —Å–ª–æ–≤${fileParsed.length - newCount > 0 ? ' (' + (fileParsed.length - newCount) + ' –¥—É–±–ª–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏–º)' : ''}`;
        };
        if (file.name.endsWith('.csv')) {
          const reader = new FileReader();
          reader.onload = e => {
            let raw = e.target.result;
            if (raw.charCodeAt(0) === 0xfeff) raw = raw.slice(1);
            const lines = raw.split('\n').filter(l => l.trim());
            const hasHdr =
              lines[0].toLowerCase().includes('english') ||
              lines[0].toLowerCase().includes('russian');
            const dataL = hasHdr ? lines.slice(1) : lines;
            const parseL = line => {
              const cols = [];
              let cur = '',
                inQ = false;
              for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                  inQ = !inQ;
                } else if ((ch === ',' || ch === '\t') && !inQ) {
                  cols.push(cur.trim());
                  cur = '';
                } else cur += ch;
              }
              cols.push(cur.trim());
              return cols.map(s => s.replace(/^"|"$/g, '').replace(/""/g, '"'));
            };
            fileParsed = dataL
              .map(l => {
                const cols = parseL(l);
                return {
                  en: cols[0] || '',
                  ru: cols[1] || '',
                  ex: cols[2] || '',
                };
              })
              .filter(w => w.en && w.ru);
            showPreview();
          };
          reader.readAsText(file, 'UTF-8');
        } else {
          const reader = new FileReader();
          reader.onload = e => {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            fileParsed = data
              .slice(1)
              .map(r => ({
                en: (r[0] || '').toString().trim(),
                ru: (r[1] || '').toString().trim(),
                ex: (r[2] || '').toString().trim(),
              }))
              .filter(w => w.en && w.ru);
            showPreview();
          };
          reader.readAsBinaryString(file);
        }
      }
      document
        .getElementById('import-file-btn')
        .addEventListener('click', () => {
          const checked = [...document.querySelectorAll('.fchk:checked')].map(
            c => +c.dataset.i,
          );
          let added = 0;
          checked.forEach(i => {
            const w = fileParsed[i];
            if (!words.find(x => x.en.toLowerCase() === w.en.toLowerCase())) {
              addWord(w.en, w.ru, w.ex, []);
              added++;
            }
          });
          document.getElementById('file-preview-wrap').style.display = 'none';
          document.getElementById('import-file-btn').style.display = 'none';
          fileParsed = [];
          toast(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${added} —Å–ª–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞!`);
          renderWords();
          switchTab('words');
        });

      // ============================================================
      // IMPORT / EXPORT
      // ============================================================
      let pendingImport = null;

      function openIOModal(mode = 'export') {
        document.getElementById('io-export-view').style.display =
          mode === 'export' ? 'block' : 'none';
        document.getElementById('io-import-view').style.display =
          mode === 'import' ? 'block' : 'none';
        document.getElementById('io-modal').classList.add('open');
      }
      function closeIOModal() {
        document.getElementById('io-modal').classList.remove('open');
        pendingImport = null;
      }

      document
        .getElementById('export-btn')
        .addEventListener('click', () => openIOModal('export'));
      document
        .getElementById('import-btn')
        .addEventListener('click', () => openIOModal('import'));
      document
        .getElementById('io-close-export')
        .addEventListener('click', closeIOModal);
      document.getElementById('io-modal').addEventListener('click', e => {
        if (e.target === e.currentTarget) closeIOModal();
      });

      // Back to export view
      document.getElementById('io-back-btn').addEventListener('click', () => {
        document.getElementById('io-export-view').style.display = 'block';
        document.getElementById('io-import-view').style.display = 'none';
        pendingImport = null;
      });

      // Switch to import view
      document.getElementById('io-to-import').addEventListener('click', () => {
        document.getElementById('io-export-view').style.display = 'none';
        document.getElementById('io-import-view').style.display = 'block';
      });

      // Export JSON (full backup)
      document
        .getElementById('io-export-json')
        .addEventListener('click', () => {
          const backup = {
            version: 2,
            exportedAt: new Date().toISOString(),
            words,
            xpData,
            streak,
          };
          const blob = new Blob([JSON.stringify(backup, null, 2)], {
            type: 'application/json',
          });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download =
            'vocabmaster-backup-' +
            new Date().toISOString().slice(0, 10) +
            '.json';
          a.click();
          toast('üíæ –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
          closeIOModal();
        });

      // Export CSV
      document.getElementById('io-export-csv').addEventListener('click', () => {
        if (!words.length) {
          toast('–ù–µ—Ç —Å–ª–æ–≤', 'warning');
          return;
        }
        const rows = [
          'English,Russian,Example,Tags',
          ...words.map(
            w =>
              `"${(w.en || '').replace(/"/g, '""')}","${(w.ru || '').replace(/"/g, '""')}","${(w.ex || '').replace(/"/g, '""')}","${(w.tags || []).join(';')}"`,
          ),
        ];
        const a = document.createElement('a');
        a.href = URL.createObjectURL(
          new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8' }),
        );
        a.download =
          'vocabmaster-words-' + new Date().toISOString().slice(0, 10) + '.csv';
        a.click();
        toast('üìÑ CSV —Å–∫–∞—á–∞–Ω!', 'success');
        closeIOModal();
      });
      document
        .getElementById('io-export-anki')
        .addEventListener('click', () => {
          if (!words.length) {
            toast('–ù–µ—Ç —Å–ª–æ–≤', 'warning');
            return;
          }
          const rows = words.map(w => {
            const front = w.ex
              ? `${w.en}<br><i style="font-size:.85em;opacity:.7">${w.ex}</i>`
              : w.en;
            const tags = w.tags.join(' ');
            return [front, w.ru, tags].join('	');
          });
          const blob = new Blob([rows.join('\r\n')], {
            type: 'text/plain;charset=utf-8',
          });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `vocabmaster_anki_${new Date().toISOString().slice(0, 10)}.txt`;
          a.click();
          toast('üÉè Anki —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
        });

      // File input handling
      function handleImportFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          let content = e.target.result;
          // –£–±–∏—Ä–∞–µ–º BOM (utf-8-sig)
          if (content.charCodeAt(0) === 0xfeff) content = content.slice(1);
          const infoEl = document.getElementById('io-import-info');
          const actionsEl = document.getElementById('io-import-actions');
          try {
            if (file.name.endsWith('.json')) {
              const data = JSON.parse(content);
              if (!data.words || !Array.isArray(data.words))
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
              pendingImport = { type: 'json', data };
              infoEl.innerHTML = `‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤: <b>${data.words.length}</b>${data.xpData ? ' ¬∑ XP –∏ –±–µ–π–¥–∂–∏ –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã' : ''}<br><span style="color:var(--danger);font-size:.75rem">‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ —Å–ª–æ–≤–∞ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!</span>`;
            } else if (file.name.endsWith('.csv')) {
              const lines = content
                .trim()
                .split('\n')
                .filter(l => l.trim());
              const hasHeader =
                lines[0].toLowerCase().includes('english') ||
                lines[0].toLowerCase().includes('russian');
              const dataLines = hasHeader ? lines.slice(1) : lines;
              const parseCSVLine = line => {
                const cols = [];
                let cur = '',
                  inQ = false;
                for (let i = 0; i < line.length; i++) {
                  const ch = line[i];
                  if (ch === '"') {
                    inQ = !inQ;
                  } else if ((ch === ',' || ch === '\t') && !inQ) {
                    cols.push(cur.trim());
                    cur = '';
                  } else cur += ch;
                }
                cols.push(cur.trim());
                return cols.map(s =>
                  s.replace(/^"|"$/g, '').replace(/""/g, '"'),
                );
              };
              const parsed = dataLines
                .map(line => {
                  const cols = parseCSVLine(line);
                  return {
                    en: cols[0] || '',
                    ru: cols[1] || '',
                    ex: cols[2] || '',
                    tags: cols[3] ? cols[3].split(';').filter(Boolean) : [],
                  };
                })
                .filter(w => w.en && w.ru);
              if (!parsed.length) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤ –≤ CSV');
              pendingImport = { type: 'csv', data: parsed };
              infoEl.innerHTML = `‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤: <b>${parsed.length}</b><br><span style="color:var(--warning);font-size:.75rem">‚ÑπÔ∏è –°–ª–æ–≤–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º</span>`;
            } else {
              throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
            }
            infoEl.style.display = 'block';
            actionsEl.style.display = 'flex';
          } catch (err) {
            infoEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + err.message;
            infoEl.style.display = 'block';
            actionsEl.style.display = 'none';
            pendingImport = null;
          }
        };
        reader.readAsText(file, 'utf-8');
      }

      const importDropZone = document.getElementById('io-drop-zone');
      const importFileInput = document.getElementById('io-file-input');

      importDropZone.addEventListener('click', () => importFileInput.click());
      importFileInput.addEventListener('change', e =>
        handleImportFile(e.target.files[0]),
      );

      importDropZone.addEventListener('dragover', e => {
        e.preventDefault();
        importDropZone.classList.add('drag-over');
      });
      importDropZone.addEventListener('dragleave', () =>
        importDropZone.classList.remove('drag-over'),
      );
      importDropZone.addEventListener('drop', e => {
        e.preventDefault();
        importDropZone.classList.remove('drag-over');
        handleImportFile(e.dataTransfer.files[0]);
      });

      // Confirm import
      document
        .getElementById('io-confirm-import')
        .addEventListener('click', () => {
          if (!pendingImport) return;
          if (pendingImport.type === 'json') {
            const d = pendingImport.data;
            words = d.words;
            if (d.xpData) {
              xpData = d.xpData;
              saveXP();
            }
            if (d.streak) {
              streak = d.streak;
              saveStreak();
            }
            save();
            renderWords();
            renderStats();
            renderXP();
            renderBadges();
            toast(
              '‚úÖ –ë—ç–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! ' + words.length + ' —Å–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ',
              'success',
            );
          } else if (pendingImport.type === 'csv') {
            let added = 0;
            pendingImport.data.forEach(w => {
              if (!words.find(x => x.en.toLowerCase() === w.en.toLowerCase())) {
                words.push(mkWord(w.en, w.ru, w.ex, w.tags));
                added++;
              }
            });
            save();
            renderWords();
            renderStats();
            toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ' + added + ' –Ω–æ–≤—ã—Ö —Å–ª–æ–≤!', 'success');
          }
          closeIOModal();
          pendingImport = null;
          fileInput.value = '';
        });

      // ============================================================
      // PRACTICE
      // ============================================================
      let session = null,
        sIdx = 0,
        sResults = { correct: [], wrong: [] };
      let autoPron = true,
        lastSessionConfig = null;

      document.querySelectorAll('.chip[data-count]').forEach(c =>
        c.addEventListener('click', () => {
          document
            .querySelectorAll('.chip[data-count]')
            .forEach(x => x.classList.remove('on'));
          c.classList.add('on');
        }),
      );
      document.querySelectorAll('.chip[data-filter-w]').forEach(c =>
        c.addEventListener('click', () => {
          document
            .querySelectorAll('.chip[data-filter-w]')
            .forEach(x => x.classList.remove('on'));
          c.classList.add('on');
        }),
      );
      document.querySelectorAll('.chip[data-autopron]').forEach(c =>
        c.addEventListener('click', () => {
          document
            .querySelectorAll('.chip[data-autopron]')
            .forEach(x => x.classList.remove('on'));
          c.classList.add('on');
          autoPron = c.dataset.autopron === 'on';
        }),
      );
      document.querySelectorAll('.chip[data-dir]').forEach(b =>
        b.addEventListener('click', () => {
          document
            .querySelectorAll('.chip[data-dir]')
            .forEach(x => x.classList.remove('on'));
          b.classList.add('on');
        }),
      );

      document
        .getElementById('start-btn')
        .addEventListener('click', () => startSession());

      function startSession(cfg) {
        sResults = { correct: [], wrong: [] };
        sIdx = 0;
        words.forEach(w => delete w._matched);

        let countVal, filterVal, exTypes, types, pool;

        if (cfg && cfg.countVal !== undefined) {
          // –ü–æ–≤—Ç–æ—Ä —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏
          ({ countVal, filterVal, exTypes } = cfg);
          types = speechSupported
            ? exTypes
            : exTypes.filter(t => t !== 'dictation');
          if (!types.length) {
            toast('–î–∏–∫—Ç–∞–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏', 'danger');
            return;
          }
          pool = [...words];
          if (filterVal === 'learning')
            pool = pool.filter(w => !w.stats.learned);
          if (filterVal === 'due') {
            const now = new Date();
            pool = pool.filter(w => new Date(w.stats.nextReview) <= now);
          }
          if (filterVal === 'random')
            pool = pool.sort(() => Math.random() - 0.5);
          if (!pool.length) {
            toast('–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏', 'warning');
            return;
          }
          const cnt =
            countVal === 'all'
              ? pool.length
              : Math.min(parseInt(countVal), pool.length);
          pool = pool.sort(() => Math.random() - 0.5).slice(0, cnt);
        } else {
          // –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
          countVal = document.querySelector('.chip[data-count].on').dataset
            .count;
          filterVal = document.querySelector('.chip[data-filter-w].on').dataset
            .filterW;
          exTypes = [...document.querySelectorAll('[data-ex]:checked')].map(
            c => c.dataset.ex,
          );
          if (!exTypes.length) {
            toast('–í—ã–±–µ—Ä–∏ —Ç–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π', 'warning');
            return;
          }
          types = speechSupported
            ? exTypes
            : exTypes.filter(t => t !== 'dictation');
          if (!types.length) {
            toast('–î–∏–∫—Ç–∞–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏', 'danger');
            return;
          }
          pool = [...words];
          if (filterVal === 'learning')
            pool = pool.filter(w => !w.stats.learned);
          if (filterVal === 'due') {
            const now = new Date();
            pool = pool.filter(w => new Date(w.stats.nextReview) <= now);
          }
          if (filterVal === 'random')
            pool = pool.sort(() => Math.random() - 0.5);
          if (!pool.length) {
            toast('–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏', 'warning');
            return;
          }
          const count =
            countVal === 'all'
              ? pool.length
              : Math.min(parseInt(countVal), pool.length);
          pool = pool.sort(() => Math.random() - 0.5).slice(0, count);
          lastSessionConfig = { countVal, filterVal, exTypes };
        }

        const dirVal =
          document.querySelector('.chip[data-dir].on')?.dataset.dir || 'both';
        session = { words: pool, exTypes: types, dir: dirVal };
        document.getElementById('practice-setup').style.display = 'none';
        document.getElementById('practice-results').style.display = 'none';
        document.getElementById('practice-ex').style.display = 'block';
        nextExercise();
      }

      function nextExercise() {
        const hkHint = document.getElementById('hotkeys-hint');
        if (hkHint) hkHint.style.display = 'flex';
        if (sIdx >= session.words.length) {
          showResults();
          return;
        }
        const w = session.words[sIdx];
        const t =
          session.exTypes[Math.floor(Math.random() * session.exTypes.length)];
        document.getElementById('prog-fill').style.width =
          Math.round((sIdx / session.words.length) * 100) + '%';
        document.getElementById('ex-counter').textContent =
          `${sIdx + 1} / ${session.words.length}`;
        const content = document.getElementById('ex-content');
        const btns = document.getElementById('ex-btns');
        btns.innerHTML = '';

        // Auto-pronounce: –≤—ã–Ω–µ—Å–µ–Ω–æ –≤–Ω—É—Ç—Ä—å –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (—É—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

        if (t === 'match') {
          // –ë–µ—Ä—ë–º –¥–æ 6 —Å–ª–æ–≤ –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
          const batchSize = Math.min(6, session.words.length - sIdx);
          if (batchSize < 2) {
            // –ú–µ–Ω—å—à–µ 2 —Å–ª–æ–≤ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º match, –±–µ—Ä—ë–º flash
            session.exTypes = session.exTypes.filter(x => x !== 'match');
            if (!session.exTypes.length) session.exTypes = ['flash'];
            nextExercise();
            return;
          }
          const batch = session.words.slice(sIdx, sIdx + batchSize);
          runMatchExercise(batch, elapsed => {
            sIdx += batchSize;
            toast(`üß© –í—Å–µ –ø–∞—Ä—ã –∑–∞ ${elapsed}s!`, 'success');
            nextExercise();
          });
          return;
        }

        if (t === 'flash') {
          document.getElementById('ex-type-lbl').textContent =
            'üÉè –§–ª–µ—à-–∫–∞—Ä—Ç–æ—á–∫–∞';
          const dir = session.dir || 'both';
          const showRU =
            dir === 'ru-en' || (dir === 'both' && Math.random() > 0.5);
          const frontWord = showRU ? w.ru : w.en;
          const backWord = showRU ? w.en : w.ru;
          content.innerHTML = `
      <div class="flashcard-scene" id="fc-scene">
        <div class="flashcard-inner" id="fc-inner">
          <div class="card-face front">
            <div style="display:flex;align-items:center;gap:.75rem">
              <div class="card-word">${esc(frontWord)}</div>
              ${!showRU && speechSupported ? `<button class="btn-audio" id="fc-audio-btn" title="–ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏">üîä</button>` : ''}
            </div>
            <div class="card-hint" style="font-size:.7rem;opacity:.5">${showRU ? 'RU' : 'EN'} ¬∑ –Ω–∞–∂–º–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
          </div>
          <div class="card-face back">
            <div class="card-trans">${esc(backWord)}</div>
            ${!showRU && w.ex ? `<div class="card-ex">${esc(w.ex)}</div>` : ''}
          </div>
        </div>
      </div>
    `;
          document.getElementById('fc-scene').addEventListener('click', e => {
            if (e.target.closest('.btn-audio')) return;
            document.getElementById('fc-inner').classList.toggle('flipped');
          });
          if (!showRU && speechSupported) {
            document
              .getElementById('fc-audio-btn')
              .addEventListener('click', e => {
                e.stopPropagation();
                speakBtn(w.en, e.currentTarget);
              });
          }
          if (autoPron && !showRU && speechSupported)
            setTimeout(() => speak(w.en), 300);
          btns.innerHTML = `<button class="btn btn-success" id="knew-btn">üíö –ó–Ω–∞–ª</button><button class="btn btn-danger" id="didnt-btn">‚ù§Ô∏è –ù–µ –∑–Ω–∞–ª</button>`;
          document.getElementById('knew-btn').onclick = () =>
            recordAnswer(true);
          document.getElementById('didnt-btn').onclick = () =>
            recordAnswer(false);
        } else if (t === 'multi') {
          document.getElementById('ex-type-lbl').textContent =
            'üéØ –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞';
          const dir = session.dir || 'both';
          const isRUEN =
            dir === 'ru-en' || (dir === 'both' && Math.random() > 0.5);
          const question = isRUEN ? w.ru : w.en;
          const correct = isRUEN ? w.en : w.ru;
          const others = words
            .filter(x => x.id !== w.id)
            .sort(() => Math.random() - 0.5)
            .slice(0, 3)
            .map(x => (isRUEN ? x.en : x.ru));
          let options = [...others, correct]
            .sort(() => Math.random() - 0.5)
            .slice(0, 4);
          if (!options.includes(correct)) options[0] = correct;
          if (autoPron && !isRUEN && speechSupported)
            setTimeout(() => speak(w.en), 300);
          content.innerHTML = `
      <div class="mc-question">
        ${esc(question)}
        ${!isRUEN && speechSupported ? `<button class="btn-audio" id="mc-audio-btn">üîä</button>` : ''}
      </div>
      <div class="mc-grid">${options.map(o => `<button class="mc-btn" data-ans="${esc(o)}">${esc(o)}</button>`).join('')}</div>
    `;
          if (!isRUEN && speechSupported)
            document
              .getElementById('mc-audio-btn')
              .addEventListener('click', e => {
                e.stopPropagation();
                speakBtn(w.en, e.currentTarget);
              });
          content.querySelectorAll('.mc-btn').forEach(b =>
            b.addEventListener('click', () => {
              const ok = b.dataset.ans === correct;
              content.querySelectorAll('.mc-btn').forEach(x => {
                x.disabled = true;
                if (x.dataset.ans === correct) x.classList.add('correct');
              });
              if (!ok) b.classList.add('wrong');
              if (ok && speechSupported) speak(w.en);
              setTimeout(() => recordAnswer(ok), 1100);
            }),
          );
        } else if (t === 'type') {
          document.getElementById('ex-type-lbl').textContent =
            '‚å®Ô∏è –ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–≤–æ–¥';
          const dir = session.dir || 'both';
          const isRUEN =
            dir === 'ru-en' || (dir === 'both' && Math.random() > 0.5);
          const question = isRUEN ? w.ru : w.en;
          const answer = isRUEN ? w.en : w.ru;
          if (autoPron && !isRUEN && speechSupported)
            setTimeout(() => speak(w.en), 300);
          content.innerHTML = `
      <div class="ta-word">
        ${esc(question)}
        ${!isRUEN && speechSupported ? `<button class="btn-audio" id="ta-audio-btn">üîä</button>` : ''}
      </div>
      <div class="ta-row">
        <input type="text" id="ta-input" placeholder="${isRUEN ? '–ù–∞–ø–∏—à–∏ –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏...' : '–í–≤–µ–¥–∏ –ø–µ—Ä–µ–≤–æ–¥...'}" autocomplete="off" autocorrect="off" spellcheck="false">
        <button class="btn btn-primary" id="ta-submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div class="ta-feedback" id="ta-fb"></div>
    `;
          if (!isRUEN && speechSupported)
            document
              .getElementById('ta-audio-btn')
              .addEventListener('click', e => {
                e.stopPropagation();
                speakBtn(w.en, e.currentTarget);
              });
          const inp = document.getElementById('ta-input');
          inp.focus();
          const check = () => {
            const val = inp.value.trim().toLowerCase();
            const ok = val === answer.toLowerCase();
            const fb = document.getElementById('ta-fb');
            fb.className = 'ta-feedback ' + (ok ? 'ok' : 'err');
            fb.textContent = ok ? '‚úÖ –í–µ—Ä–Ω–æ!' : '‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ' + answer;
            inp.disabled = true;
            document.getElementById('ta-submit').disabled = true;
            if (ok && speechSupported) speak(w.en);
            setTimeout(() => recordAnswer(ok), 1300);
          };
          document.getElementById('ta-submit').onclick = check;
          inp.addEventListener('keydown', e => {
            if (e.key === 'Enter') check();
          });
        } else if (t === 'dictation') {
          document.getElementById('ex-type-lbl').textContent = 'üîä –î–∏–∫—Ç–∞–Ω—Ç';
          content.innerHTML = `
      <div class="dictation-card">
        <div class="dictation-big">üîä</div>
        <div class="dictation-hint">–ü–æ—Å–ª—É—à–∞–π —Å–ª–æ–≤–æ –∏ –Ω–∞–ø–∏—à–∏ –µ–≥–æ –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏</div>
        <div class="dictation-reveal" id="dict-reveal">${esc(w.en)}</div>
      </div>
      <div class="ta-row" style="margin-top:1rem">
        <input type="text" id="dict-input" placeholder="–ù–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏..." autocomplete="off" autocorrect="off" spellcheck="false">
        <button class="btn btn-primary" id="dict-submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div class="ta-feedback" id="dict-fb"></div>
    `;
          // Play immediately
          setTimeout(() => speak(w.en), 200);
          btns.innerHTML = `<button class="btn btn-secondary" id="dict-replay">üîÅ –ü–æ–≤—Ç–æ—Ä</button>`;
          document.getElementById('dict-replay').onclick = () => speak(w.en);
          const inp = document.getElementById('dict-input');
          inp.focus();
          const check = () => {
            const val = inp.value.trim().toLowerCase();
            const ok = val === w.en.toLowerCase();
            const fb = document.getElementById('dict-fb');
            fb.className = 'ta-feedback ' + (ok ? 'ok' : 'err');
            fb.textContent = ok ? '‚úÖ –í–µ—Ä–Ω–æ!' : '‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ' + w.en;
            document.getElementById('dict-reveal').style.display = 'block';
            inp.disabled = true;
            document.getElementById('dict-submit').disabled = true;
            setTimeout(() => recordAnswer(ok), 1400);
          };
          document.getElementById('dict-submit').onclick = check;
          inp.addEventListener('keydown', e => {
            if (e.key === 'Enter') check();
          });
        }
      }

      function recordAnswer(correct) {
        playSound(correct ? 'correct' : 'wrong');
        updStats(session.words[sIdx].id, correct);
        updStreak();
        if (correct) sResults.correct.push(session.words[sIdx]);
        else sResults.wrong.push(session.words[sIdx]);
        sIdx++;
        nextExercise();
      }

      function showResults() {
        const hkHint = document.getElementById('hotkeys-hint');
        if (hkHint) hkHint.style.display = 'none';
        updateDueBadge();
        renderStats();
        document.getElementById('practice-ex').style.display = 'none';
        document.getElementById('practice-results').style.display = 'block';
        const resTotal = sResults.correct.length + sResults.wrong.length;
        const resCorrect = sResults.correct.length;
        const resPct = resTotal ? Math.round((resCorrect / resTotal) * 100) : 0;
        document.getElementById('r-score').textContent =
          `${resCorrect}/${resTotal}`;
        document.getElementById('r-label').textContent =
          `–ø—Ä–∞–≤–∏–ª—å–Ω–æ ¬∑ ${resPct}% —Ç–æ—á–Ω–æ—Å—Ç—å`;
        const r = 50,
          cx = 65,
          cy = 65,
          circ = 2 * Math.PI * r;
        document.getElementById('r-ring').innerHTML = `
    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--border)" stroke-width="10"/>
    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--primary)" stroke-width="10"
      stroke-dasharray="${circ}" stroke-dashoffset="${circ * (1 - resPct / 100)}"
      transform="rotate(-90 ${cx} ${cy})" style="transition:stroke-dashoffset .8s ease"/>
    <text x="${cx}" y="${cy + 7}" text-anchor="middle" font-size="20" font-weight="800" fill="var(--text)">${resPct}%</text>
  `;
        document.getElementById('r-correct').innerHTML = sResults.correct
          .map(w => `<li>${esc(w.en)} ‚Äî ${esc(w.ru)}</li>`)
          .join('');
        document.getElementById('r-wrong').innerHTML = sResults.wrong
          .map(w => `<li>${esc(w.en)} ‚Äî ${esc(w.ru)}</li>`)
          .join('');
        spawnConfetti();
        // XP
        const xpCorrect = resCorrect;
        const xpTotal = resTotal;
        if (xpCorrect > 0) gainXP(xpCorrect * 10, xpCorrect + ' –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö');
        const isPerfect = xpTotal >= 5 && xpCorrect === xpTotal;
        if (isPerfect) gainXP(30, '–∏–¥–µ–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è üéØ');
        updStreak();
        checkBadges(isPerfect);
      }

      document.getElementById('again-btn').addEventListener('click', () => {
        document.getElementById('practice-results').style.display = 'none';
        startSession(lastSessionConfig);
      });
      document.getElementById('setup-btn').addEventListener('click', () => {
        document.getElementById('practice-results').style.display = 'none';
        document.getElementById('practice-setup').style.display = 'block';
      });

      // ============================================================
      // CONFETTI
      // ============================================================
      function spawnConfetti() {
        document.querySelectorAll('.confetti-piece').forEach(p => p.remove());
        const colors = [
          '#6C63FF',
          '#22C55E',
          '#F59E0B',
          '#EF4444',
          '#8B84FF',
          '#34D399',
        ];
        for (let i = 0; i < 60; i++) {
          const p = document.createElement('div');
          const s = 8 + Math.random() * 8;
          p.className = 'confetti-piece';
          p.style.cssText = `left:${Math.random() * 100}vw;top:-20px;width:${s}px;height:${s}px;background:${colors[Math.floor(Math.random() * colors.length)]};border-radius:${Math.random() > 0.5 ? '50%' : '3px'};animation-duration:${2 + Math.random() * 2}s;animation-delay:${Math.random() * 0.8}s;`;
          document.body.appendChild(p);
          setTimeout(() => p.remove(), 4000);
        }
      }

      // ============================================================
      // STATS
      // ============================================================
      function renderStats() {
        const total = words.length;
        // SRS: due count
        const now = new Date();
        const dueCount = words.filter(
          w => new Date(w.stats.nextReview || now) <= now,
        ).length;
        document.getElementById('st-due').textContent = dueCount;
        const pillEl = document.getElementById('due-pill');
        if (pillEl) pillEl.textContent = dueCount;
        const learned = words.filter(w => w.stats.learned).length;
        const pct = total ? Math.round((learned / total) * 100) : 0;
        const weekAgo = new Date(Date.now() - 7 * 86400000);
        const thisWeek = words.filter(
          w => new Date(w.createdAt) > weekAgo,
        ).length;
        document.getElementById('st-total').textContent = total;
        document.getElementById('st-learned').textContent = learned;
        document.getElementById('st-learned-bar').style.width = pct + '%';
        document.getElementById('st-streak').textContent = streak.count;
        document.getElementById('st-week').textContent = thisWeek;

        // Sparkline
        const days = [],
          labels = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const ds = d.toDateString();
          days.push(
            words.filter(w => new Date(w.createdAt).toDateString() === ds)
              .length,
          );
          labels.push(['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'][d.getDay()]);
        }
        const maxV = Math.max(...days, 1);
        const pts = days
          .map((v, i) => `${i * (400 / 6)},${80 - (v / maxV) * 65}`)
          .join(' ');
        document.getElementById('spark-svg').innerHTML = `
    <polyline points="${pts}" fill="none" stroke="var(--primary)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    ${days
      .map((v, i) => {
        const x = i * (400 / 6),
          y = 80 - (v / maxV) * 65;
        return `<circle cx="${x}" cy="${y}" r="5" fill="var(--primary)"/>${v ? `<text x="${x}" y="${y - 10}" text-anchor="middle" font-size="13" fill="var(--text)" font-weight="700">${v}</text>` : ''}`;
      })
      .join('')}
  `;
        document.getElementById('spark-labels').innerHTML = labels
          .map(l => `<span>${l}</span>`)
          .join('');

        const practiced = words.filter(w => w.stats.shown > 0);
        const hard = [...practiced]
          .sort(
            (a, b) =>
              a.stats.correct / a.stats.shown - b.stats.correct / b.stats.shown,
          )
          .slice(0, 5);
        const easy = [...practiced]
          .sort(
            (a, b) =>
              b.stats.correct / b.stats.shown - a.stats.correct / a.stats.shown,
          )
          .slice(0, 5);

        document.getElementById('st-hard').innerHTML =
          hard
            .map(
              w => `
    <li>
      <span>${esc(w.en)}</span>
      <div style="display:flex;align-items:center;gap:.5rem">
        ${speechSupported ? `<button class="btn-audio wlist-audio" data-word="${esc(w.en)}" style="width:28px;height:28px;font-size:.8rem">üîä</button>` : ''}
        <span class="cnt">${w.stats.correct}/${w.stats.shown}</span>
      </div>
    </li>
  `,
            )
            .join('') || '<li style="color:var(--muted)">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>';

        document.getElementById('st-easy').innerHTML =
          easy
            .map(
              w => `
    <li>
      <span>${esc(w.en)}</span>
      <div style="display:flex;align-items:center;gap:.5rem">
        ${speechSupported ? `<button class="btn-audio wlist-audio" data-word="${esc(w.en)}" style="width:28px;height:28px;font-size:.8rem">üîä</button>` : ''}
        <span class="cnt">${Math.round((w.stats.correct / w.stats.shown) * 100)}%</span>
      </div>
    </li>
  `,
            )
            .join('') || '<li style="color:var(--muted)">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>';

        // Audio in stats lists
        document.querySelectorAll('.wlist-audio').forEach(btn => {
          btn.addEventListener('click', () => speakBtn(btn.dataset.word, btn));
        });

        // Update speech settings UI
        document.getElementById('speed-range').value = speechCfg.rate;
        document.getElementById('speed-val').textContent = speechCfg.rate + 'x';
        document.getElementById('pitch-range').value = speechCfg.pitch;
        document.getElementById('pitch-val').textContent =
          speechCfg.pitch.toFixed(1);
        setTimeout(loadVoices, 100);
      }

      // ============================================================
      // INIT
      // ============================================================
      // –ú–æ—Å—Ç –¥–ª—è Firebase
      window._getLocalWords = () => words;
      window._setWords = newWords => {
        words = newWords;
        renderWords();
        renderStats();
        renderXP();
        updateDueBadge();
        renderWotd();
      };

      load();
      updStreak();
      updateDueBadge();
      renderWotd();
      renderWords();
      renderXP();
      renderBadges();
      renderStats();

      // === –ó–í–£–ö–ò ===
      function playSound(type) {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          if (type === 'correct') {
            const oscs = [];
            [
              [523.25, 0, 0.12],
              [659.25, 0.06, 0.12],
            ].forEach(([freq, delay, dur]) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain);
              gain.connect(ctx.destination);
              osc.type = 'sine';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, ctx.currentTime + delay);
              gain.gain.linearRampToValueAtTime(
                0.18,
                ctx.currentTime + delay + 0.02,
              );
              gain.gain.exponentialRampToValueAtTime(
                0.001,
                ctx.currentTime + delay + dur,
              );
              osc.start(ctx.currentTime + delay);
              osc.stop(ctx.currentTime + delay + dur + 0.05);
              oscs.push(osc);
            });
            oscs[oscs.length - 1].onended = () => ctx.close();
          } else {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(330, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(
              220,
              ctx.currentTime + 0.18,
            );
            gain.gain.setValueAtTime(0.15, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(
              0.001,
              ctx.currentTime + 0.22,
            );
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.25);
            osc.onended = () => ctx.close();
          }
        } catch (e) {}
      }

      // === DUE BADGE ===
      function updateDueBadge() {
        const badge = document.getElementById('due-badge');
        if (!badge) return;
        const now = new Date();
        const due = words.filter(
          w => new Date(w.stats.nextReview || now) <= now,
        ).length;
        if (due > 0) {
          badge.textContent = due > 99 ? '99+' : due;
          badge.style.display = 'inline-block';
        } else badge.style.display = 'none';
      }

      // === WORD OF THE DAY ===
      function renderWotd() {
        const wrap = document.getElementById('wotd-wrap');
        if (!wrap || !words.length) {
          if (wrap) wrap.innerHTML = '';
          return;
        }
        const today = new Date().toDateString();
        let seed = 0;
        for (let i = 0; i < today.length; i++)
          seed = (seed * 31 + today.charCodeAt(i)) & 0xffff;
        const w = words[seed % words.length];
        wrap.innerHTML = `<div class="wotd-card">
    <div>
      <div class="wotd-label">‚òÄÔ∏è –°–ª–æ–≤–æ –¥–Ω—è</div>
      <div class="wotd-en">${esc(w.en)}</div>
      <div class="wotd-ru">${esc(w.ru)}</div>
      ${w.ex ? `<div class="wotd-ex">${esc(w.ex)}</div>` : ''}
    </div>
    ${speechSupported ? `<button class="wotd-audio" id="wotd-audio-btn">üîä</button>` : ''}
  </div>`;
        if (speechSupported) {
          document
            .getElementById('wotd-audio-btn')
            .addEventListener('click', function () {
              speakBtn(w.en, this);
            });
        }
      }

      // === MATCH MADNESS ===
      function runMatchExercise(words6, onComplete) {
        const content = document.getElementById('ex-content');
        const btns = document.getElementById('ex-btns');
        btns.innerHTML = '';
        document.getElementById('ex-type-lbl').textContent = 'üß© –ù–∞–π–¥–∏ –ø–∞—Ä—ã';

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –æ—Ç–¥–µ–ª—å–Ω–æ
        const enWords = [...words6];
        const ruWords = [...words6].sort(() => Math.random() - 0.5);

        let selectedEN = null; // { el, word }
        let matched = 0;
        const total = words6.length;
        let startTime = Date.now();

        content.innerHTML = `
    <div class="match-timer" id="match-timer">0.0s</div>
    <div class="match-grid" id="match-grid"></div>
    <div class="match-progress" id="match-progress">0 / ${total} –ø–∞—Ä</div>
  `;

        // –¢–∏–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        const timerEl = document.getElementById('match-timer');
        window._matchTimerInterval = setInterval(() => {
          if (timerEl)
            timerEl.textContent =
              ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        }, 100);

        const grid = document.getElementById('match-grid');

        function renderGrid() {
          grid.innerHTML = '';
          for (let i = 0; i < total; i++) {
            const enW = enWords[i];
            const ruW = ruWords[i];

            // EN –∫–Ω–æ–ø–∫–∞
            const enBtn = document.createElement('button');
            enBtn.className = 'match-btn';
            enBtn.dataset.id = enW.id;
            enBtn.dataset.side = 'en';
            enBtn.textContent = enW.en;
            if (enW._matched) {
              enBtn.classList.add('correct');
              enBtn.disabled = true;
            }

            // RU –∫–Ω–æ–ø–∫–∞
            const ruBtn = document.createElement('button');
            ruBtn.className = 'match-btn';
            ruBtn.dataset.id = ruW.id;
            ruBtn.dataset.side = 'ru';
            ruBtn.textContent = ruW.ru;
            if (ruW._matched) {
              ruBtn.classList.add('correct');
              ruBtn.disabled = true;
            }

            grid.appendChild(enBtn);
            grid.appendChild(ruBtn);
          }
        }
        renderGrid();

        // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏
        grid.addEventListener('click', e => {
          const btn = e.target.closest('.match-btn');
          if (!btn || btn.disabled || btn.classList.contains('correct')) return;
          const side = btn.dataset.side;
          const id = btn.dataset.id;

          if (side === 'en') {
            // –°–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π selected EN
            grid
              .querySelectorAll('.match-btn[data-side="en"].selected')
              .forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedEN = { el: btn, id };
            return;
          }

          // –ö–ª–∏–∫ –ø–æ RU ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º
          if (!selectedEN) return;

          if (selectedEN.id === id) {
            // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ!
            playSound('correct');
            btn.classList.add('correct');
            selectedEN.el.classList.remove('selected');
            selectedEN.el.classList.add('correct');
            // –ü–æ–º–µ—á–∞–µ–º —Å–ª–æ–≤–æ –∫–∞–∫ matched
            words6.find(w => w.id === id)._matched = true;
            enWords.find(w => w.id === id)._matched = true;
            ruWords.find(w => w.id === id)._matched = true;
            selectedEN = null;
            matched++;
            document.getElementById('match-progress').textContent =
              `${matched} / ${total} –ø–∞—Ä`;
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updStats(id, true);
            updStreak();
            sResults.correct.push(words6.find(w => w.id === id));

            if (matched === total) {
              clearInterval(window._matchTimerInterval);
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
              setTimeout(() => {
                // –û—á–∏—â–∞–µ–º _matched
                words6.forEach(w => delete w._matched);
                enWords.forEach(w => delete w._matched);
                ruWords.forEach(w => delete w._matched);
                onComplete(elapsed);
              }, 600);
            }
          } else {
            // –û—à–∏–±–∫–∞
            playSound('wrong');
            btn.classList.add('wrong');
            selectedEN.el.classList.add('wrong');
            updStats(selectedEN.id, false);
            sResults.wrong.push(words6.find(w => w.id === selectedEN.id));
            setTimeout(() => {
              btn.classList.remove('wrong');
              if (selectedEN)
                selectedEN.el.classList.remove('wrong', 'selected');
              selectedEN = null;
            }, 400);
          }
        });
      }

      // === HOTKEYS ===
      document.addEventListener('keydown', e => {
        if (
          ['INPUT', 'TEXTAREA', 'SELECT'].includes(
            document.activeElement.tagName,
          )
        )
          return;
        const exPane = document.getElementById('practice-ex');
        if (!exPane || exPane.style.display === 'none') return;
        const key = e.key;
        if (key === ' ' || key === 'f' || key === 'F') {
          const fc = document.getElementById('fc-inner');
          if (fc) {
            e.preventDefault();
            fc.classList.toggle('flipped');
          }
          return;
        }
        if (key === 'y' || key === 'Y' || key === 'ArrowRight') {
          const b = document.getElementById('knew-btn');
          if (b && !b.disabled) {
            e.preventDefault();
            b.click();
          }
          return;
        }
        if (key === 'n' || key === 'N' || key === 'ArrowLeft') {
          const b = document.getElementById('didnt-btn');
          if (b && !b.disabled) {
            e.preventDefault();
            b.click();
          }
          return;
        }
        if (['1', '2', '3', '4'].includes(key)) {
          const btns = [
            ...document.querySelectorAll('.mc-btn:not([disabled])'),
          ];
          if (btns[+key - 1]) {
            e.preventDefault();
            btns[+key - 1].click();
          }
          return;
        }
        if (key === 'p' || key === 'P') {
          const ab =
            document.getElementById('fc-audio-btn') ||
            document.getElementById('mc-audio-btn') ||
            document.getElementById('ta-audio-btn');
          if (ab) {
            e.preventDefault();
            ab.click();
          }
        }
      });

      // === EXIT SESSION ===
      document.getElementById('ex-exit-btn').addEventListener('click', () => {
        if (!confirm('–í—ã–π—Ç–∏ –∏–∑ —É—Ä–æ–∫–∞?')) return;
        words.forEach(w => delete w._matched);
        clearInterval(window._matchTimerInterval);
        document.getElementById('practice-ex').style.display = 'none';
        document.getElementById('practice-setup').style.display = 'block';
        const hkHint = document.getElementById('hotkeys-hint');
        if (hkHint) hkHint.style.display = 'none';
      });
      // === PWA ===
      (function initPWA() {
        const manifest = {
          name: 'VocabMaster',
          short_name: 'VocabMaster',
          description: '–£—á–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞',
          start_url: './',
          display: 'standalone',
          background_color: '#F0F2FF',
          theme_color: '#6C63FF',
          icons: [
            {
              src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%236C63FF"/><text y=".9em" font-size="80" x="10">üìö</text></svg>',
              sizes: '192x192',
              type: 'image/svg+xml',
            },
            {
              src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%236C63FF"/><text y=".9em" font-size="80" x="10">üìö</text></svg>',
              sizes: '512x512',
              type: 'image/svg+xml',
            },
          ],
        };
        const blob = new Blob([JSON.stringify(manifest)], {
          type: 'application/json',
        });
        document.getElementById('pwa-manifest').href =
          URL.createObjectURL(blob);

        if ('serviceWorker' in navigator) {
          const swCode = `
      const CACHE = 'vocabmaster-v1';
      const ASSETS = [self.location.href];
      self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS))));
      self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
    `;
          const swBlob = new Blob([swCode], { type: 'application/javascript' });
          navigator.serviceWorker
            .register(URL.createObjectURL(swBlob))
            .catch(() => {});
        }

        window.addEventListener('beforeinstallprompt', e => {
          e.preventDefault();
          let deferredPrompt = e;
          const btn = document.createElement('button');
          btn.className = 'btn btn-primary btn-sm';
          btn.innerHTML = 'üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
          btn.style.cssText =
            'position:fixed;bottom:1.5rem;left:1.5rem;z-index:9999;box-shadow:0 4px 20px rgba(108,99,255,0.4)';
          document.body.appendChild(btn);
          btn.addEventListener('click', () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => btn.remove());
          });
        });
      })();
    </script>

    <!-- Import/Export Modal -->
    <!-- AUTH MODAL -->
    <div class="modal-backdrop" id="auth-modal">
      <div class="modal-box" style="max-width: 380px">
        <h3 id="auth-modal-title">–í–æ–π—Ç–∏</h3>
        <div class="form-group">
          <label>Email</label>
          <input
            type="email"
            id="auth-email"
            placeholder="you@example.com"
            autocomplete="email"
          />
        </div>
        <div class="form-group">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input
            type="password"
            id="auth-password"
            placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
            autocomplete="current-password"
          />
        </div>
        <div
          id="auth-error"
          style="
            color: var(--danger);
            font-size: 0.85rem;
            font-weight: 700;
            min-height: 1.2rem;
            margin-bottom: 0.75rem;
          "
        ></div>
        <div class="modal-actions" style="flex-direction: column; gap: 0.5rem">
          <button
            class="btn btn-primary"
            style="width: 100%"
            id="auth-submit-btn"
          >
            –í–æ–π—Ç–∏
          </button>
          <button
            class="btn btn-secondary"
            style="width: 100%"
            id="auth-toggle-btn"
          >
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          </button>
          <button
            class="btn"
            style="width: 100%; color: var(--muted)"
            id="auth-close-btn"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </div>
    </div>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="db.js"></script>

    <script type="module" src="auth.js"></script>
  </body>
</html>
